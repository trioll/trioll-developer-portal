<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Developer ID Display</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #0f0f0f;
            color: #fff;
        }
        .section {
            background: #1a1a1a;
            padding: 25px;
            margin: 20px 0;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }
        h1 { color: #3b82f6; margin-bottom: 30px; }
        h2 { color: #e5e7eb; margin-bottom: 15px; font-size: 20px; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
            transition: all 0.2s;
        }
        button:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #0f0f0f;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
        }
        .success { 
            border-left: 4px solid #10b981; 
            background: rgba(16, 185, 129, 0.1);
        }
        .error { 
            border-left: 4px solid #ef4444; 
            background: rgba(239, 68, 68, 0.1);
        }
        .warning { 
            border-left: 4px solid #f59e0b; 
            background: rgba(245, 158, 11, 0.1);
        }
        .fix-button {
            background: #10b981;
        }
        .fix-button:hover {
            background: #059669;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-good { background: #10b981; }
        .status-bad { background: #ef4444; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>üîß Developer ID Display Fix</h1>
    
    <div class="section">
        <h2><span class="status-indicator" id="authStatus"></span>Authentication Status</h2>
        <button onclick="checkAuthStatus()">Check Auth Status</button>
        <div id="authResult" class="result"></div>
    </div>
    
    <div class="section">
        <h2><span class="status-indicator" id="storageStatus"></span>Storage Check</h2>
        <button onclick="checkStorage()">Check All Storage</button>
        <div id="storageResult" class="result"></div>
    </div>
    
    <div class="section">
        <h2><span class="status-indicator" id="profileStatus"></span>Developer Profile</h2>
        <button onclick="loadProfile()">Load Profile from API</button>
        <button onclick="fixProfile()" class="fix-button">Auto-Fix Profile</button>
        <div id="profileResult" class="result"></div>
    </div>
    
    <div class="section">
        <h2>üéØ Quick Actions</h2>
        <button onclick="applyCompleteFix()" style="background: #10b981; font-weight: bold;">
            Apply Complete Fix
        </button>
        <button onclick="clearAndRelogin()">Clear & Re-login</button>
        <button onclick="goToPortal()">Go to Portal</button>
        <div id="actionResult" class="result"></div>
    </div>

    <script>
        // Load auth service
        const script = document.createElement('script');
        script.src = 'auth-service.js';
        document.head.appendChild(script);

        async function checkAuthStatus() {
            const resultDiv = document.getElementById('authResult');
            const statusDiv = document.getElementById('authStatus');
            
            const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
            const refreshToken = localStorage.getItem('developerRefreshToken') || sessionStorage.getItem('developerRefreshToken');
            
            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå No authentication token found\n\nYou need to login first.';
                statusDiv.className = 'status-indicator status-bad';
                return;
            }
            
            try {
                // Decode token to get info
                const payload = JSON.parse(atob(token.split('.')[1]));
                const email = payload.email || payload['cognito:username'] || 'Unknown';
                const exp = new Date(payload.exp * 1000);
                const isExpired = exp < new Date();
                
                resultDiv.className = isExpired ? 'result error' : 'result success';
                resultDiv.textContent = `${isExpired ? '‚ùå' : '‚úÖ'} Token ${isExpired ? 'Expired' : 'Valid'}\n`;
                resultDiv.textContent += `Email: ${email}\n`;
                resultDiv.textContent += `Expires: ${exp.toLocaleString()}\n`;
                resultDiv.textContent += `Token Location: ${localStorage.getItem('developerToken') ? 'localStorage' : 'sessionStorage'}`;
                
                statusDiv.className = isExpired ? 'status-indicator status-bad' : 'status-indicator status-good';
            } catch (e) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Invalid token format';
                statusDiv.className = 'status-indicator status-bad';
            }
        }

        function checkStorage() {
            const resultDiv = document.getElementById('storageResult');
            const statusDiv = document.getElementById('storageStatus');
            
            const localToken = localStorage.getItem('developerToken');
            const sessionToken = sessionStorage.getItem('developerToken');
            const devInfo = localStorage.getItem('developerInfo');
            
            let hasIssues = false;
            let result = 'Storage Contents:\n\n';
            
            // Check tokens
            if (localToken && sessionToken) {
                result += '‚ö†Ô∏è  Token found in BOTH localStorage and sessionStorage (may cause conflicts)\n';
                hasIssues = true;
            } else if (localToken) {
                result += '‚úÖ Token in localStorage (persistent)\n';
            } else if (sessionToken) {
                result += '‚ö†Ô∏è  Token in sessionStorage only (will be lost on browser close)\n';
                hasIssues = true;
            } else {
                result += '‚ùå No token found\n';
                hasIssues = true;
            }
            
            // Check developer info
            if (devInfo) {
                try {
                    const parsed = JSON.parse(devInfo);
                    result += '\n‚úÖ Developer Info Found:\n';
                    result += `  - Developer ID: ${parsed.developerId || '‚ùå Missing'}\n`;
                    result += `  - Company: ${parsed.companyName || '‚ùå Missing'}\n`;
                    result += `  - Email: ${parsed.email || '‚ùå Missing'}\n`;
                    
                    if (!parsed.developerId) hasIssues = true;
                } catch (e) {
                    result += '\n‚ùå Developer info is corrupted\n';
                    hasIssues = true;
                }
            } else {
                result += '\n‚ùå No developer info in storage\n';
                hasIssues = true;
            }
            
            resultDiv.className = hasIssues ? 'result warning' : 'result success';
            resultDiv.textContent = result;
            statusDiv.className = hasIssues ? 'status-indicator status-bad' : 'status-indicator status-good';
        }

        async function loadProfile() {
            const resultDiv = document.getElementById('profileResult');
            const statusDiv = document.getElementById('profileStatus');
            
            if (typeof auth === 'undefined') {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Auth service not loaded';
                statusDiv.className = 'status-indicator status-bad';
                return;
            }
            
            resultDiv.className = 'result';
            resultDiv.textContent = '‚è≥ Loading profile from API...';
            
            try {
                const profile = await auth.loadDeveloperProfile();
                
                if (profile && profile.developerId) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '‚úÖ Profile loaded successfully!\n\n';
                    resultDiv.textContent += JSON.stringify(profile, null, 2);
                    statusDiv.className = 'status-indicator status-good';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Failed to load profile from API\n\n';
                    resultDiv.textContent += 'The API did not return developer information.';
                    statusDiv.className = 'status-indicator status-bad';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error loading profile:\n${error.message}`;
                statusDiv.className = 'status-indicator status-bad';
            }
        }

        function fixProfile() {
            const resultDiv = document.getElementById('profileResult');
            const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
            
            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå No token found. Please login first.';
                return;
            }
            
            try {
                // Decode token to get email
                const payload = JSON.parse(atob(token.split('.')[1]));
                const email = payload.email || payload['cognito:username'] || 'developer@trioll.com';
                const username = email.split('@')[0];
                
                // Generate developer ID based on username
                const devId = 'dev_' + username.substring(0, 6).padEnd(6, '0').replace(/[^a-zA-Z0-9]/g, '0');
                
                const developerInfo = {
                    developerId: devId,
                    companyName: username,
                    email: email,
                    username: username,
                    userType: 'developer',
                    joinDate: new Date().toISOString()
                };
                
                // Save to localStorage
                localStorage.setItem('developerInfo', JSON.stringify(developerInfo));
                
                // Update auth service if available
                if (typeof auth !== 'undefined') {
                    auth.developerInfo = developerInfo;
                }
                
                resultDiv.className = 'result success';
                resultDiv.textContent = '‚úÖ Developer profile created!\n\n';
                resultDiv.textContent += `Developer ID: ${devId}\n`;
                resultDiv.textContent += `Username: ${username}\n`;
                resultDiv.textContent += `Email: ${email}\n\n`;
                resultDiv.textContent += 'The portal should now display your developer ID properly.';
                
                document.getElementById('profileStatus').className = 'status-indicator status-good';
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error creating profile:\n${error.message}`;
            }
        }

        async function applyCompleteFix() {
            const resultDiv = document.getElementById('actionResult');
            resultDiv.className = 'result';
            resultDiv.textContent = '‚è≥ Applying fixes...';
            
            // Step 1: Move token to localStorage if in sessionStorage
            const sessionToken = sessionStorage.getItem('developerToken');
            if (sessionToken && !localStorage.getItem('developerToken')) {
                localStorage.setItem('developerToken', sessionToken);
                const refreshToken = sessionStorage.getItem('developerRefreshToken');
                if (refreshToken) {
                    localStorage.setItem('developerRefreshToken', refreshToken);
                }
                resultDiv.textContent += '\n‚úÖ Moved tokens to persistent storage';
            }
            
            // Step 2: Fix developer info
            fixProfile();
            resultDiv.textContent += '\n‚úÖ Created developer profile';
            
            // Step 3: Try to load from API
            if (typeof auth !== 'undefined') {
                try {
                    await auth.loadDeveloperProfile();
                    resultDiv.textContent += '\n‚úÖ Attempted API profile sync';
                } catch (e) {
                    resultDiv.textContent += '\n‚ö†Ô∏è  API sync failed (using local data)';
                }
            }
            
            resultDiv.className = 'result success';
            resultDiv.textContent += '\n\nüéâ Fix applied! Click "Go to Portal" to see your developer ID.';
        }

        function clearAndRelogin() {
            if (confirm('This will log you out and clear all stored data. Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }

        function goToPortal() {
            window.location.href = 'index.html';
        }

        // Auto-check on load
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                checkAuthStatus();
                checkStorage();
            }, 500);
        });
    </script>
</body>
</html>