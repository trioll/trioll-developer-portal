<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Comments System</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #0f0f0f;
            color: #fff;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .section {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        textarea, input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #fff;
            border-radius: 6px;
            resize: vertical;
        }
        .comment {
            background: #0f0f0f;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #9ca3af;
        }
        .comment-author {
            color: #60a5fa;
            font-weight: 600;
        }
        .comment-text {
            margin: 10px 0;
            line-height: 1.5;
        }
        .comment-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 13px;
        }
        .comment-action {
            color: #6b7280;
            cursor: pointer;
        }
        .comment-action:hover {
            color: #3b82f6;
        }
        .rating {
            color: #fbbf24;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #0f0f0f;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .error {
            color: #ef4444;
        }
        .success {
            color: #10b981;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Comments System</h1>
    
    <div class="container">
        <!-- Post a Comment -->
        <div class="section">
            <h2>Post a Comment</h2>
            <input type="text" id="testGameId" placeholder="Game ID (e.g., game_123)" value="test_game_123">
            <textarea id="commentText" placeholder="Write your comment..." rows="3">This is a test comment from the developer portal!</textarea>
            <input type="number" id="rating" placeholder="Rating (1-5)" min="1" max="5" value="5">
            <button onclick="postComment()">Post Comment</button>
            <div id="postResult" class="result"></div>
        </div>
        
        <!-- Get Comments -->
        <div class="section">
            <h2>Get Comments</h2>
            <input type="text" id="getGameId" placeholder="Game ID" value="test_game_123">
            <button onclick="getComments()">Get Comments</button>
            <div id="commentsCount" style="margin-top: 10px; color: #9ca3af;"></div>
        </div>
        
        <!-- Comments Display -->
        <div class="section full-width">
            <h2>Comments</h2>
            <div id="commentsList"></div>
        </div>
        
        <!-- Test Different Scenarios -->
        <div class="section full-width">
            <h2>Test Scenarios</h2>
            <button onclick="testAsGuest()">Test as Guest User</button>
            <button onclick="testAsDeveloper()">Test as Developer</button>
            <button onclick="testWithoutAuth()">Test Without Auth</button>
            <button onclick="testPagination()">Test Pagination</button>
            <div id="scenarioResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://4ib0hvu1xj.execute-api.us-east-1.amazonaws.com/prod';
        
        async function postComment() {
            const resultDiv = document.getElementById('postResult');
            const gameId = document.getElementById('testGameId').value;
            const comment = document.getElementById('commentText').value;
            const rating = parseInt(document.getElementById('rating').value) || null;
            
            if (!gameId || !comment) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Game ID and comment are required';
                return;
            }
            
            // Get auth token
            const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please login to post comments';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        comment,
                        rating,
                        userName: 'Developer'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '‚úÖ Comment posted successfully!\n\n' + JSON.stringify(data, null, 2);
                    // Refresh comments
                    document.getElementById('getGameId').value = gameId;
                    getComments();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Error: ${data.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }
        
        async function getComments() {
            const gameId = document.getElementById('getGameId').value;
            const listDiv = document.getElementById('commentsList');
            const countDiv = document.getElementById('commentsCount');
            
            if (!gameId) {
                listDiv.innerHTML = '<p class="error">Please enter a game ID</p>';
                return;
            }
            
            listDiv.innerHTML = '<p>Loading comments...</p>';
            
            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/comments`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    countDiv.textContent = `Total comments: ${data.count || 0}`;
                    
                    if (data.comments && data.comments.length > 0) {
                        listDiv.innerHTML = data.comments.map(comment => `
                            <div class="comment">
                                <div class="comment-header">
                                    <div>
                                        <span class="comment-author">${comment.userName}</span>
                                        ${comment.isGuest ? '<span style="color: #6b7280;">(Guest)</span>' : ''}
                                    </div>
                                    <div>${new Date(comment.createdAt).toLocaleString()}</div>
                                </div>
                                ${comment.rating ? `<div class="rating">‚òÖ ${comment.rating}/5</div>` : ''}
                                <div class="comment-text">${comment.comment}</div>
                                <div class="comment-actions">
                                    <span class="comment-action" onclick="likeComment('${comment.commentId}')">
                                        üëç Like (${comment.likes || 0})
                                    </span>
                                    ${comment.isEdited ? '<span style="color: #6b7280;">Edited</span>' : ''}
                                    <span class="comment-action" onclick="deleteComment('${comment.gameId}', '${comment.commentId}')">
                                        üóëÔ∏è Delete
                                    </span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        listDiv.innerHTML = '<p style="color: #6b7280;">No comments yet. Be the first to comment!</p>';
                    }
                } else {
                    listDiv.innerHTML = `<p class="error">Failed to load comments: ${data.message || 'Unknown error'}</p>`;
                }
            } catch (error) {
                listDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function likeComment(commentId) {
            try {
                const response = await fetch(`${API_BASE}/comments/${commentId}/like`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // Refresh comments
                    getComments();
                }
            } catch (error) {
                console.error('Like error:', error);
            }
        }
        
        async function deleteComment(gameId, commentId) {
            if (!confirm('Delete this comment?')) return;
            
            const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
            if (!token) {
                alert('Please login to delete comments');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    // Refresh comments
                    getComments();
                } else {
                    const data = await response.json();
                    alert(`Failed to delete: ${data.message}`);
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }
        
        // Test scenarios
        async function testAsGuest() {
            const resultDiv = document.getElementById('scenarioResult');
            resultDiv.textContent = 'Testing as guest user...\n\n';
            
            try {
                const response = await fetch(`${API_BASE}/games/test_game_123/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer guest-test123'
                    },
                    body: JSON.stringify({
                        comment: 'This is a guest comment!',
                        rating: 4
                    })
                });
                
                const data = await response.json();
                resultDiv.textContent += `Guest post response: ${response.status}\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultDiv.textContent += `Error: ${error.message}`;
            }
        }
        
        async function testAsDeveloper() {
            const resultDiv = document.getElementById('scenarioResult');
            const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
            
            if (!token) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please login as developer first';
                return;
            }
            
            resultDiv.textContent = 'Testing developer permissions...\n\n';
            resultDiv.textContent += 'Developers should be able to:\n';
            resultDiv.textContent += '‚úÖ Post comments on any game\n';
            resultDiv.textContent += '‚úÖ Delete any comment on their games\n';
            resultDiv.textContent += '‚úÖ Edit their own comments\n';
        }
        
        async function testWithoutAuth() {
            const resultDiv = document.getElementById('scenarioResult');
            resultDiv.textContent = 'Testing without authentication...\n\n';
            
            try {
                // Try to get comments (should work)
                const getResponse = await fetch(`${API_BASE}/games/test_game_123/comments`);
                resultDiv.textContent += `GET comments: ${getResponse.status} ${getResponse.ok ? '‚úÖ' : '‚ùå'}\n`;
                
                // Try to post (should fail)
                const postResponse = await fetch(`${API_BASE}/games/test_game_123/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: 'Test' })
                });
                const postData = await postResponse.json();
                resultDiv.textContent += `POST comment: ${postResponse.status} ${postData.message}\n`;
            } catch (error) {
                resultDiv.textContent += `Error: ${error.message}`;
            }
        }
        
        async function testPagination() {
            const resultDiv = document.getElementById('scenarioResult');
            resultDiv.textContent = 'Testing pagination...\n\n';
            
            try {
                const response = await fetch(`${API_BASE}/games/test_game_123/comments?limit=5`);
                const data = await response.json();
                
                resultDiv.textContent += `First page: ${data.count || 0} comments\n`;
                if (data.nextKey) {
                    resultDiv.textContent += `Next page key: ${data.nextKey}\n`;
                    resultDiv.textContent += '\nTo get next page, add: ?lastKey=' + data.nextKey;
                } else {
                    resultDiv.textContent += 'No more pages';
                }
            } catch (error) {
                resultDiv.textContent += `Error: ${error.message}`;
            }
        }
        
        // Auto-load comments on page load
        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
            if (!token) {
                document.getElementById('postResult').innerHTML = '<p class="error">‚ö†Ô∏è Please login to the developer portal to test comments</p>';
            }
        });
    </script>
</body>
</html>