<!DOCTYPE html>
<html>
<head>
    <title>Fix Login State</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .section {
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        .success { color: #00ff00; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        pre {
            background: #000;
            padding: 10px;
            overflow: auto;
            border: 1px solid #333;
        }
        h1, h2 { color: #00ff00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Login State Diagnostic & Repair Tool</h1>
        
        <div class="section">
            <h2>1. Current Authentication State</h2>
            <div id="authState"></div>
        </div>
        
        <div class="section">
            <h2>2. Token Analysis</h2>
            <div id="tokenAnalysis"></div>
        </div>
        
        <div class="section">
            <h2>3. Storage Contents</h2>
            <div id="storageContents"></div>
        </div>
        
        <div class="section">
            <h2>4. Quick Actions</h2>
            <button onclick="clearAllAuth()">üóëÔ∏è Clear All Auth Data</button>
            <button onclick="fixGmailAccount()">üîß Fix Gmail Account</button>
            <button onclick="testCurrentAuth()">üß™ Test Current Auth</button>
            <button onclick="showLoginInstructions()">üìã Show Login Instructions</button>
        </div>
        
        <div class="section">
            <h2>5. Action Results</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://4ib0hvu1xj.execute-api.us-east-1.amazonaws.com/prod';
        
        function log(message, type = 'info') {
            const color = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
            return `<div class="${color}">${new Date().toLocaleTimeString()} - ${message}</div>`;
        }
        
        function checkAuthState() {
            const output = document.getElementById('authState');
            let html = '';
            
            // Check for auth-related items in storage
            const authKeys = ['developerToken', 'refreshToken', 'developerInfo', 'auth', 'token'];
            let foundAuth = false;
            
            authKeys.forEach(key => {
                const localValue = localStorage.getItem(key);
                const sessionValue = sessionStorage.getItem(key);
                
                if (localValue || sessionValue) {
                    foundAuth = true;
                    html += `<div>`;
                    html += `<strong>${key}:</strong><br>`;
                    if (localValue) html += `  localStorage: ${localValue.substring(0, 20)}...<br>`;
                    if (sessionValue) html += `  sessionStorage: ${sessionValue.substring(0, 20)}...<br>`;
                    html += `</div><br>`;
                }
            });
            
            if (!foundAuth) {
                html = '<div class="error">‚ùå No authentication data found! You are NOT logged in.</div>';
            }
            
            output.innerHTML = html;
        }
        
        function analyzeTokens() {
            const output = document.getElementById('tokenAnalysis');
            let html = '';
            
            const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
            
            if (token) {
                try {
                    const parts = token.split('.');
                    if (parts.length === 3) {
                        const payload = JSON.parse(atob(parts[1]));
                        
                        html += '<div class="success">‚úÖ Valid JWT Token Found:</div>';
                        html += '<pre>';
                        html += `Email: ${payload.email || 'NOT FOUND'}\n`;
                        html += `Developer ID: ${payload['custom:developer_id'] || payload.preferred_username || 'NOT FOUND'}\n`;
                        html += `Expires: ${new Date(payload.exp * 1000).toLocaleString()}\n`;
                        html += `Issued: ${new Date(payload.iat * 1000).toLocaleString()}\n`;
                        html += '</pre>';
                        
                        // Check if expired
                        if (Date.now() > payload.exp * 1000) {
                            html += '<div class="error">‚ö†Ô∏è TOKEN IS EXPIRED!</div>';
                        }
                        
                        // Check developer ID
                        const devId = payload['custom:developer_id'] || payload.preferred_username;
                        if (devId === 'dev_freddi_2d80f6') {
                            html += '<div class="warning">‚ö†Ô∏è OLD DEVELOPER ID DETECTED! This needs to be updated.</div>';
                        } else if (devId === 'dev_zb6q2k') {
                            html += '<div class="success">‚úÖ Correct developer ID for Gmail account</div>';
                        } else if (devId === 'dev_c84a7e') {
                            html += '<div class="success">‚úÖ Correct developer ID for Hotmail account</div>';
                        }
                    }
                } catch (e) {
                    html = `<div class="error">‚ùå Invalid token format: ${e.message}</div>`;
                }
            } else {
                html = '<div class="error">‚ùå No developer token found!</div>';
            }
            
            output.innerHTML = html;
        }
        
        function showStorageContents() {
            const output = document.getElementById('storageContents');
            let html = '<h3>All Storage Keys:</h3><pre>';
            
            html += 'LocalStorage:\n';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                html += `  ${key}\n`;
            }
            
            html += '\nSessionStorage:\n';
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                html += `  ${key}\n`;
            }
            
            html += '</pre>';
            output.innerHTML = html;
        }
        
        function clearAllAuth() {
            const results = document.getElementById('results');
            results.innerHTML = log('Clearing all authentication data...', 'warning');
            
            // Clear all auth-related keys
            const keys = ['developerToken', 'refreshToken', 'developerInfo', 'auth', 'token', 
                         'developerRefreshToken', 'rememberMe', 'authToken'];
            
            keys.forEach(key => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            });
            
            results.innerHTML += log('All authentication data cleared!', 'success');
            results.innerHTML += log('Please refresh the page and login again.', 'info');
            
            setTimeout(() => {
                checkAuthState();
                analyzeTokens();
            }, 100);
        }
        
        function fixGmailAccount() {
            const results = document.getElementById('results');
            results.innerHTML = log('Attempting to fix Gmail account authentication...', 'info');
            
            // Clear old tokens
            clearAllAuth();
            
            results.innerHTML += '<br><div class="warning">Manual steps required:</div>';
            results.innerHTML += '<ol>';
            results.innerHTML += '<li>Go back to triolldev.com</li>';
            results.innerHTML += '<li>Make sure you are logged out</li>';
            results.innerHTML += '<li>Clear browser cache (Ctrl+Shift+Del)</li>';
            results.innerHTML += '<li>Login with freddiecaplin@gmail.com</li>';
            results.innerHTML += '<li>Check "Remember Me" box</li>';
            results.innerHTML += '<li>After login, return here to verify</li>';
            results.innerHTML += '</ol>';
        }
        
        async function testCurrentAuth() {
            const results = document.getElementById('results');
            const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
            
            if (!token) {
                results.innerHTML = log('No authentication token found!', 'error');
                return;
            }
            
            results.innerHTML = log('Testing authentication...', 'info');
            
            try {
                // Test developer profile endpoint
                const profileResponse = await fetch(`${API_ENDPOINT}/developers/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (profileResponse.ok) {
                    const profile = await profileResponse.json();
                    results.innerHTML += log('‚úÖ Profile endpoint working!', 'success');
                    results.innerHTML += `<pre>${JSON.stringify(profile, null, 2)}</pre>`;
                } else {
                    results.innerHTML += log(`‚ùå Profile endpoint failed: ${profileResponse.status}`, 'error');
                    const error = await profileResponse.text();
                    results.innerHTML += `<pre>${error}</pre>`;
                }
                
                // Test developer games endpoint
                const gamesResponse = await fetch(`${API_ENDPOINT}/developers/games`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (gamesResponse.ok) {
                    const games = await gamesResponse.json();
                    results.innerHTML += log(`‚úÖ Games endpoint working! Found ${games.games?.length || 0} games`, 'success');
                } else {
                    results.innerHTML += log(`‚ùå Games endpoint failed: ${gamesResponse.status}`, 'error');
                }
                
            } catch (e) {
                results.innerHTML += log(`Error: ${e.message}`, 'error');
            }
        }
        
        function showLoginInstructions() {
            const results = document.getElementById('results');
            results.innerHTML = `
                <h3>Complete Login Instructions:</h3>
                <ol>
                    <li><strong>Clear Everything:</strong>
                        <ul>
                            <li>Click "Clear All Auth Data" button above</li>
                            <li>Clear browser cache: Ctrl+Shift+Delete (Windows) or Cmd+Shift+Delete (Mac)</li>
                            <li>Close ALL triolldev.com tabs</li>
                        </ul>
                    </li>
                    <li><strong>Fresh Login:</strong>
                        <ul>
                            <li>Open new incognito/private window</li>
                            <li>Go to triolldev.com</li>
                            <li>Click "Login" (not Sign Up)</li>
                            <li>Use: freddiecaplin@gmail.com</li>
                            <li>Check "Remember Me" box</li>
                        </ul>
                    </li>
                    <li><strong>Verify:</strong>
                        <ul>
                            <li>After login, check "My Games" tab</li>
                            <li>Should show 0 games for Gmail account</li>
                            <li>Developer ID should be: dev_zb6q2k</li>
                        </ul>
                    </li>
                </ol>
                <div class="warning">
                    <strong>Important:</strong> Your accounts are now separate:<br>
                    - freddiecaplin@gmail.com = dev_zb6q2k (0 games)<br>
                    - freddiecaplin@hotmail.com = dev_c84a7e (7 games)
                </div>
            `;
        }
        
        // Run checks on load
        checkAuthState();
        analyzeTokens();
        showStorageContents();
    </script>
</body>
</html>