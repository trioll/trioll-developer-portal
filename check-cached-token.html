<!DOCTYPE html>
<html>
<head>
    <title>Token Cache Checker</title>
    <style>
        body {
            font-family: monospace;
            background: #111;
            color: #0ff;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #0ff;
            background: rgba(0, 255, 255, 0.1);
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
    </style>
</head>
<body>
    <h1>Token Cache Diagnostic Tool</h1>
    
    <div class="section">
        <h2>1. Current Token Analysis</h2>
        <div id="tokenAnalysis"></div>
    </div>
    
    <div class="section">
        <h2>2. Storage Analysis</h2>
        <div id="storageAnalysis"></div>
    </div>
    
    <div class="section">
        <h2>3. Clear Cache Options</h2>
        <button onclick="clearAllTokens()">Clear All Tokens</button>
        <button onclick="clearLocalStorage()">Clear LocalStorage</button>
        <button onclick="clearSessionStorage()">Clear SessionStorage</button>
        <div id="clearResult"></div>
    </div>
    
    <div class="section">
        <h2>4. Test API Call</h2>
        <button onclick="testDeveloperGames()">Test /developers/games</button>
        <div id="apiResult"></div>
    </div>

    <script>
        function analyzeToken(token) {
            if (!token) return null;
            try {
                const parts = token.split('.');
                if (parts.length !== 3) return null;
                const payload = JSON.parse(atob(parts[1]));
                return payload;
            } catch (e) {
                return null;
            }
        }
        
        function checkTokens() {
            const output = document.getElementById('tokenAnalysis');
            let html = '';
            
            // Check all possible token locations
            const locations = [
                { name: 'localStorage - token', value: localStorage.getItem('token') },
                { name: 'localStorage - developerToken', value: localStorage.getItem('developerToken') },
                { name: 'localStorage - authToken', value: localStorage.getItem('authToken') },
                { name: 'sessionStorage - token', value: sessionStorage.getItem('token') },
                { name: 'sessionStorage - developerToken', value: sessionStorage.getItem('developerToken') },
                { name: 'sessionStorage - authToken', value: sessionStorage.getItem('authToken') }
            ];
            
            locations.forEach(loc => {
                if (loc.value) {
                    const payload = analyzeToken(loc.value);
                    if (payload) {
                        const developerId = payload['custom:developer_id'] || 
                                           payload.preferred_username || 
                                           payload.developerId || 
                                           'NOT FOUND';
                        const email = payload.email || 'NOT FOUND';
                        const exp = new Date(payload.exp * 1000).toLocaleString();
                        
                        html += `<div class="${developerId.includes('freddi') ? 'warning' : 'success'}">`;
                        html += `<strong>${loc.name}</strong><br>`;
                        html += `Email: ${email}<br>`;
                        html += `Developer ID: ${developerId}<br>`;
                        html += `Expires: ${exp}<br>`;
                        html += `</div><br>`;
                    }
                }
            });
            
            output.innerHTML = html || '<div class="error">No tokens found!</div>';
        }
        
        function checkStorage() {
            const output = document.getElementById('storageAnalysis');
            let html = '<h3>LocalStorage:</h3>';
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('dev') || key.includes('auth') || key.includes('token')) {
                    html += `${key}: ${localStorage.getItem(key).substring(0, 50)}...<br>`;
                }
            }
            
            html += '<br><h3>SessionStorage:</h3>';
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key.includes('dev') || key.includes('auth') || key.includes('token')) {
                    html += `${key}: ${sessionStorage.getItem(key).substring(0, 50)}...<br>`;
                }
            }
            
            output.innerHTML = html;
        }
        
        function clearAllTokens() {
            const keys = ['token', 'developerToken', 'authToken', 'refreshToken'];
            keys.forEach(key => {
                localStorage.removeItem(key);
                sessionStorage.removeItem(key);
            });
            document.getElementById('clearResult').innerHTML = '<div class="success">All tokens cleared! Please login again.</div>';
            setTimeout(() => checkTokens(), 100);
        }
        
        function clearLocalStorage() {
            localStorage.clear();
            document.getElementById('clearResult').innerHTML = '<div class="success">LocalStorage cleared!</div>';
            setTimeout(() => checkTokens(), 100);
        }
        
        function clearSessionStorage() {
            sessionStorage.clear();
            document.getElementById('clearResult').innerHTML = '<div class="success">SessionStorage cleared!</div>';
            setTimeout(() => checkTokens(), 100);
        }
        
        async function testDeveloperGames() {
            const output = document.getElementById('apiResult');
            const token = localStorage.getItem('developerToken') || 
                         sessionStorage.getItem('developerToken') ||
                         localStorage.getItem('token');
            
            if (!token) {
                output.innerHTML = '<div class="error">No token found!</div>';
                return;
            }
            
            const payload = analyzeToken(token);
            const developerId = payload?.preferred_username || payload?.['custom:developer_id'] || 'UNKNOWN';
            
            output.innerHTML = `<div>Testing with developer ID: ${developerId}</div>`;
            
            try {
                const response = await fetch('https://4ib0hvu1xj.execute-api.us-east-1.amazonaws.com/prod/developers/games', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                output.innerHTML += `<div class="success">Response: ${data.games?.length || 0} games for ${data.developerId}</div>`;
                output.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (e) {
                output.innerHTML += `<div class="error">Error: ${e.message}</div>`;
            }
        }
        
        // Run checks on load
        checkTokens();
        checkStorage();
    </script>
</body>
</html>