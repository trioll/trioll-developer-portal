<\!DOCTYPE html>
<html>
<head>
    <title>Comprehensive Game Update Test</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background: #0f0f0f;
            color: #fff;
        }
        .container {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
            margin-bottom: 20px;
        }
        h1 { 
            color: #3b82f6;
            margin-bottom: 10px;
        }
        h2 { 
            color: #60a5fa;
            margin-top: 30px;
            border-bottom: 1px solid #2a2a2a;
            padding-bottom: 10px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
        }
        button:hover { 
            background: #2563eb; 
            transform: translateY(-1px);
        }
        button:disabled { 
            opacity: 0.5; 
            cursor: not-allowed;
            transform: none;
        }
        button.secondary {
            background: #374151;
        }
        button.secondary:hover {
            background: #4b5563;
        }
        button.danger {
            background: #ef4444;
        }
        button.danger:hover {
            background: #dc2626;
        }
        .log {
            background: #0a0a0a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #2a2a2a;
        }
        .success { color: #10b981; font-weight: 600; }
        .error { color: #ef4444; font-weight: 600; }
        .info { color: #3b82f6; }
        .warning { color: #f59e0b; }
        .dim { color: #6b7280; }
        
        .status-card {
            background: #111111;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #93c5fd;
            font-size: 16px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }
        .status-value {
            font-family: monospace;
            color: #60a5fa;
        }
        
        .game-preview {
            background: #111111;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .game-preview h3 {
            color: #60a5fa;
            margin: 0 0 15px 0;
        }
        .game-field {
            display: flex;
            margin: 8px 0;
            font-size: 14px;
        }
        .game-label {
            color: #9ca3af;
            min-width: 150px;
        }
        .game-value {
            color: #fff;
            font-family: monospace;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #111111;
            border-radius: 8px;
            border: 1px solid #2a2a2a;
        }
        
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #9ca3af;
            font-size: 14px;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #374151;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
        }
        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin: 0 4px;
        }
        .badge.success { background: #065f46; color: #10b981; }
        .badge.error { background: #7f1d1d; color: #ef4444; }
        .badge.info { background: #1e3a8a; color: #60a5fa; }
        
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #374151;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Comprehensive Game Update Test Suite</h1>
        <p>Test all aspects of the game update functionality with detailed logging and verification.</p>
    </div>

    <div class="container">
        <h2>üë§ Authentication Status</h2>
        <div id="authStatus" class="status-card">
            <div class="status-item">
                <span>Status:</span>
                <span class="status-value" id="authStatusValue">Checking...</span>
            </div>
            <div class="status-item">
                <span>Email:</span>
                <span class="status-value" id="authEmail">-</span>
            </div>
            <div class="status-item">
                <span>Developer ID:</span>
                <span class="status-value" id="authDevId">-</span>
            </div>
            <div class="status-item">
                <span>Token Expiry:</span>
                <span class="status-value" id="authExpiry">-</span>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üéÆ Quick Tests</h2>
        <div class="button-group">
            <button onclick="runAllTests()" id="runAllBtn">üöÄ Run All Tests</button>
            <button onclick="testAuth()" class="secondary">üîë Test Authentication</button>
            <button onclick="testFetchGames()" class="secondary">üìã Fetch My Games</button>
            <button onclick="testUpdateFirst()" class="secondary">‚úèÔ∏è Update First Game</button>
            <button onclick="testOwnership()" class="secondary">üîí Test Ownership</button>
            <button onclick="testStandardization()" class="secondary">üîß Check Standardization</button>
            <button onclick="clearLog()" class="danger">üóëÔ∏è Clear Log</button>
        </div>
    </div>

    <div class="container">
        <h2>üéØ Custom Game Update</h2>
        <div class="test-section">
            <div class="input-group">
                <label>Game ID:</label>
                <input type="text" id="customGameId" placeholder="e.g., evolution-runner-001">
            </div>
            <div class="input-group">
                <label>New Title:</label>
                <input type="text" id="customTitle" placeholder="Updated Game Title">
            </div>
            <div class="input-group">
                <label>New Description:</label>
                <textarea id="customDescription" placeholder="Updated game description..."></textarea>
            </div>
            <div class="input-group">
                <label>New Category:</label>
                <input type="text" id="customCategory" placeholder="Action, Puzzle, etc.">
            </div>
            <button onclick="testCustomUpdate()">Update Custom Game</button>
        </div>
    </div>

    <div class="container">
        <h2>üìä Test Results</h2>
        <div id="log" class="log">Waiting for tests to run...</div>
    </div>

    <div id="gamePreview"></div>

    <script>
        const API = 'https://4ib0hvu1xj.execute-api.us-east-1.amazonaws.com/prod';
        let currentToken = null;
        let currentDeveloper = null;
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<span class="dim">[${time}]</span> ${message}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = 'Log cleared. Ready for new tests...';
        }
        
        function updateAuthStatus(status, email = '-', devId = '-', expiry = '-') {
            document.getElementById('authStatusValue').textContent = status;
            document.getElementById('authStatusValue').className = status === 'Authenticated' ? 'status-value success' : 'status-value error';
            document.getElementById('authEmail').textContent = email;
            document.getElementById('authDevId').textContent = devId;
            document.getElementById('authExpiry').textContent = expiry;
        }
        
        async function checkAuth() {
            currentToken = sessionStorage.getItem('developerToken') || 
                         localStorage.getItem('developerToken');
            
            if (\!currentToken) {
                updateAuthStatus('Not Authenticated');
                return false;
            }
            
            try {
                const payload = JSON.parse(atob(currentToken.split('.')[1]));
                currentDeveloper = {
                    email: payload.email,
                    devId: payload['custom:developer_id'] || 'Unknown',
                    exp: payload.exp
                };
                
                const expiryDate = new Date(payload.exp * 1000);
                const isExpired = expiryDate < new Date();
                
                if (isExpired) {
                    updateAuthStatus('Token Expired', payload.email, currentDeveloper.devId, expiryDate.toLocaleString());
                    return false;
                }
                
                updateAuthStatus('Authenticated', payload.email, currentDeveloper.devId, expiryDate.toLocaleString());
                return true;
            } catch (e) {
                updateAuthStatus('Invalid Token');
                return false;
            }
        }
        
        async function testAuth() {
            clearLog();
            log('üîë Testing Authentication...', 'info');
            
            const isAuth = await checkAuth();
            if (\!isAuth) {
                log('‚ùå Not authenticated. Please login to the developer portal first.', 'error');
                return false;
            }
            
            log(`‚úÖ Authenticated as: ${currentDeveloper.email}`, 'success');
            log(`Developer ID: ${currentDeveloper.devId}`, 'info');
            
            // Test token validity with API
            try {
                const response = await fetch(`${API}/developers/games`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'X-App-Client': 'developer-portal'
                    }
                });
                
                if (response.ok) {
                    log('‚úÖ Token is valid and accepted by API', 'success');
                } else {
                    log(`‚ö†Ô∏è API rejected token: ${response.status}`, 'warning');
                }
            } catch (e) {
                log(`‚ùå Failed to verify token: ${e.message}`, 'error');
            }
            
            return true;
        }
        
        async function testFetchGames() {
            log('\nüìã Fetching your games...', 'info');
            
            if (\!currentToken) {
                log('‚ùå No authentication token', 'error');
                return null;
            }
            
            try {
                const response = await fetch(`${API}/developers/games`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'X-App-Client': 'developer-portal'
                    }
                });
                
                if (\!response.ok) {
                    const error = await response.text();
                    log(`‚ùå Failed to fetch games: ${response.status}`, 'error');
                    log(error, 'error');
                    return null;
                }
                
                const data = await response.json();
                const games = data.games || [];
                
                log(`‚úÖ Found ${games.length} games`, 'success');
                
                if (data.stats) {
                    log('\nüìä Developer Stats:', 'info');
                    log(`  Total Plays: ${data.stats.totalPlays}`, 'info');
                    log(`  Total Ratings: ${data.stats.totalRatings}`, 'info');
                    log(`  Average Rating: ${data.stats.averageRating}‚≠ê`, 'info');
                }
                
                // Display games
                games.forEach((game, idx) => {
                    log(`\nüéÆ Game ${idx + 1}: "${game.title || game.name}"`, 'success');
                    log(`  ID: ${game.id}`, 'dim');
                    log(`  Category: ${game.category}`, 'dim');
                    log(`  Status: ${game.status || 'active'}`, 'dim');
                    log(`  Developer ID: ${game.developerId}`, 'dim');
                    log(`  Uploaded By: ${game.uploadedBy || 'unknown'}`, 'dim');
                });
                
                return games;
            } catch (e) {
                log(`‚ùå Error: ${e.message}`, 'error');
                return null;
            }
        }
        
        async function testUpdateFirst() {
            log('\n‚úèÔ∏è Testing Update on First Game...', 'info');
            
            const games = await testFetchGames();
            if (\!games || games.length === 0) {
                log('‚ùå No games found to update', 'error');
                return;
            }
            
            const game = games[0];
            const gameId = game.id;
            
            showGamePreview(game, 'Before Update');
            
            const timestamp = new Date().toISOString();
            const updateData = {
                name: game.title || game.name,
                description: `[TEST UPDATE] Updated via comprehensive test at ${timestamp}\n\n${game.description || ''}`,
                category: game.category || 'Action',
                status: 'active'
            };
            
            log('\nüì§ Sending update...', 'info');
            log(`PUT ${API}/games/${gameId}`, 'dim');
            
            try {
                const response = await fetch(`${API}/games/${gameId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`,
                        'X-App-Client': 'developer-portal'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.text();
                
                if (\!response.ok) {
                    log(`‚ùå Update failed: ${response.status}`, 'error');
                    log(result, 'error');
                    return;
                }
                
                log('‚úÖ Update successful\!', 'success');
                log(result, 'dim');
                
                // Verify update
                log('\nüîç Verifying update...', 'info');
                const verifyResponse = await fetch(`${API}/games/${gameId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'X-App-Client': 'developer-portal'
                    }
                });
                
                if (verifyResponse.ok) {
                    const updatedGame = await verifyResponse.json();
                    showGamePreview(updatedGame, 'After Update');
                    
                    if (updatedGame.description && updatedGame.description.includes('[TEST UPDATE]')) {
                        log('‚úÖ Update verified successfully\!', 'success');
                    } else {
                        log('‚ö†Ô∏è Update may not have persisted correctly', 'warning');
                    }
                }
            } catch (e) {
                log(`‚ùå Error: ${e.message}`, 'error');
            }
        }
        
        async function testOwnership() {
            log('\nüîí Testing Ownership Verification...', 'info');
            
            // Test 1: Try to update own game
            log('\n1Ô∏è‚É£ Testing update on own game...', 'info');
            const ownGames = await testFetchGames();
            if (ownGames && ownGames.length > 0) {
                const gameId = ownGames[0].id;
                try {
                    const response = await fetch(`${API}/games/${gameId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentToken}`,
                            'X-App-Client': 'developer-portal'
                        },
                        body: JSON.stringify({
                            name: ownGames[0].title,
                            description: 'Ownership test',
                            category: ownGames[0].category
                        })
                    });
                    
                    if (response.ok) {
                        log('‚úÖ Can update own game', 'success');
                    } else {
                        const error = await response.text();
                        log(`‚ùå Cannot update own game: ${error}`, 'error');
                    }
                } catch (e) {
                    log(`‚ùå Error: ${e.message}`, 'error');
                }
            }
            
            // Test 2: Try to update a game that's not yours (simulate)
            log('\n2Ô∏è‚É£ Testing rejection for other developer\'s game...', 'info');
            const fakeGameId = 'other-developer-game-123';
            try {
                const response = await fetch(`${API}/games/${fakeGameId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`,
                        'X-App-Client': 'developer-portal'
                    },
                    body: JSON.stringify({
                        name: 'Should Fail',
                        description: 'This should not work',
                        category: 'Test'
                    })
                });
                
                if (\!response.ok) {
                    const error = await response.text();
                    if (error.includes('not found') || error.includes('ownership')) {
                        log('‚úÖ Correctly rejected update to non-owned game', 'success');
                    } else {
                        log(`‚ö†Ô∏è Rejected with unexpected error: ${error}`, 'warning');
                    }
                } else {
                    log('‚ùå SECURITY ISSUE: Could update another developer\'s game\!', 'error');
                }
            } catch (e) {
                log(`‚ùå Error: ${e.message}`, 'error');
            }
        }
        
        async function testStandardization() {
            log('\nüîß Checking Developer ID Standardization...', 'info');
            
            const games = await testFetchGames();
            if (\!games || games.length === 0) {
                log('No games to check', 'info');
                return;
            }
            
            let needsStandardization = 0;
            let alreadyStandardized = 0;
            
            games.forEach(game => {
                const hasCorrectDevId = game.developerId === currentDeveloper.devId;
                const hasEmail = game.developerEmail === currentDeveloper.email;
                
                if (hasCorrectDevId && hasEmail) {
                    alreadyStandardized++;
                } else {
                    needsStandardization++;
                    log(`‚ö†Ô∏è Game "${game.title}" needs standardization:`, 'warning');
                    log(`  Current developerId: ${game.developerId || 'none'}`, 'dim');
                    log(`  Expected: ${currentDeveloper.devId}`, 'dim');
                }
            });
            
            log(`\nüìä Standardization Status:`, 'info');
            log(`  ‚úÖ Standardized: ${alreadyStandardized} games`, 'success');
            log(`  ‚ö†Ô∏è Need update: ${needsStandardization} games`, needsStandardization > 0 ? 'warning' : 'success');
            
            if (needsStandardization > 0) {
                log('\nüí° Run the standardization script to fix this:', 'info');
                log('  cd backend-updates && ./run-developer-standardization.sh', 'dim');
            }
        }
        
        async function testCustomUpdate() {
            const gameId = document.getElementById('customGameId').value.trim();
            const title = document.getElementById('customTitle').value.trim();
            const description = document.getElementById('customDescription').value.trim();
            const category = document.getElementById('customCategory').value.trim();
            
            if (\!gameId) {
                log('‚ùå Please enter a Game ID', 'error');
                return;
            }
            
            log(`\nüéØ Custom Update for Game: ${gameId}`, 'info');
            
            const updateData = {};
            if (title) updateData.name = title;
            if (description) updateData.description = description;
            if (category) updateData.category = category;
            
            if (Object.keys(updateData).length === 0) {
                log('‚ùå Please enter at least one field to update', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API}/games/${gameId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`,
                        'X-App-Client': 'developer-portal'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.text();
                
                if (\!response.ok) {
                    log(`‚ùå Update failed: ${response.status}`, 'error');
                    log(result, 'error');
                } else {
                    log('‚úÖ Custom update successful\!', 'success');
                    log(result, 'dim');
                }
            } catch (e) {
                log(`‚ùå Error: ${e.message}`, 'error');
            }
        }
        
        async function runAllTests() {
            const btn = document.getElementById('runAllBtn');
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Running Tests... <span class="loading"></span>';
            
            clearLog();
            log('üöÄ Starting Comprehensive Test Suite', 'info');
            log('=' .repeat(50), 'dim');
            
            // Test 1: Authentication
            const authOk = await testAuth();
            if (\!authOk) {
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Run All Tests';
                return;
            }
            
            // Test 2: Fetch Games
            await new Promise(r => setTimeout(r, 500));
            const games = await testFetchGames();
            
            // Test 3: Update First Game
            if (games && games.length > 0) {
                await new Promise(r => setTimeout(r, 500));
                await testUpdateFirst();
            }
            
            // Test 4: Ownership Verification
            await new Promise(r => setTimeout(r, 500));
            await testOwnership();
            
            // Test 5: Standardization Check
            await new Promise(r => setTimeout(r, 500));
            await testStandardization();
            
            log('\n' + '=' .repeat(50), 'dim');
            log('‚úÖ All tests completed\!', 'success');
            
            btn.disabled = false;
            btn.innerHTML = 'üöÄ Run All Tests';
        }
        
        function showGamePreview(game, title) {
            const previewEl = document.getElementById('gamePreview');
            const html = `
                <div class="container">
                    <div class="game-preview">
                        <h3>${title}</h3>
                        <div class="game-field">
                            <span class="game-label">ID:</span>
                            <span class="game-value">${game.id}</span>
                        </div>
                        <div class="game-field">
                            <span class="game-label">Title:</span>
                            <span class="game-value">${game.title || game.name}</span>
                        </div>
                        <div class="game-field">
                            <span class="game-label">Description:</span>
                            <span class="game-value">${(game.description || '').substring(0, 100)}...</span>
                        </div>
                        <div class="game-field">
                            <span class="game-label">Category:</span>
                            <span class="game-value">${game.category}</span>
                        </div>
                        <div class="game-field">
                            <span class="game-label">Status:</span>
                            <span class="game-value">${game.status || 'active'}</span>
                        </div>
                        <div class="game-field">
                            <span class="game-label">Developer ID:</span>
                            <span class="game-value">${game.developerId || 'none'}</span>
                        </div>
                        <div class="game-field">
                            <span class="game-label">Last Updated:</span>
                            <span class="game-value">${game.updatedAt || game.lastModified || 'unknown'}</span>
                        </div>
                    </div>
                </div>
            `;
            previewEl.innerHTML = html;
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            if (currentToken) {
                log('Ready to run tests. Click "Run All Tests" to begin.', 'info');
            } else {
                log('Not authenticated. Please login to the developer portal first.', 'error');
                log('Visit: https://triolldev.com', 'info');
            }
        });
    </script>
</body>
</html>
EOF < /dev/null