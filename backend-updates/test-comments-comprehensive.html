<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comments System Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .test-card {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.2s, border-color 0.2s;
        }
        
        .test-card:hover {
            transform: translateY(-2px);
            border-color: #3a3a3a;
        }
        
        .test-card h3 {
            color: #60a5fa;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .test-card input,
        .test-card textarea,
        .test-card select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #fff;
            border-radius: 6px;
            font-family: inherit;
        }
        
        .test-card button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 5px 5px 0;
            transition: background 0.2s;
        }
        
        .test-card button:hover {
            background: #2563eb;
        }
        
        .test-card button.secondary {
            background: #4b5563;
        }
        
        .test-card button.secondary:hover {
            background: #374151;
        }
        
        .test-card button.danger {
            background: #ef4444;
        }
        
        .test-card button.danger:hover {
            background: #dc2626;
        }
        
        .result-box {
            margin-top: 15px;
            padding: 12px;
            background: #0f0f0f;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #2a2a2a;
        }
        
        .success {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
        }
        
        .error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }
        
        .info {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
            border-color: #60a5fa;
        }
        
        .comments-display {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .comment-item {
            background: #0f0f0f;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
            color: #9ca3af;
        }
        
        .comment-author {
            color: #60a5fa;
            font-weight: 600;
        }
        
        .comment-rating {
            color: #fbbf24;
            margin: 5px 0;
        }
        
        .comment-text {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .comment-actions {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .comment-action {
            color: #6b7280;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: color 0.2s, background 0.2s;
        }
        
        .comment-action:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            margin-top: 10px;
        }
        
        .status-indicator.connected {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .status-indicator.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .test-summary {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .test-summary h2 {
            color: #60a5fa;
            margin-bottom: 15px;
        }
        
        .test-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-card {
            background: #0f0f0f;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #60a5fa;
        }
        
        .stat-card .label {
            color: #9ca3af;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .auth-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tab-container {
            margin: 20px 0;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 20px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #fff;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab-button.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="auth-status" id="authStatus">
        <span>Checking auth...</span>
    </div>

    <div class="header">
        <h1>üß™ Comments System Test Suite</h1>
        <p>Comprehensive testing for Trioll Comments API</p>
    </div>

    <div class="container">
        <!-- Quick Actions -->
        <div class="test-grid">
            <div class="test-card">
                <h3>üéÆ Test Configuration</h3>
                <input type="text" id="testGameId" placeholder="Game ID (e.g., game_123)" value="test_game_123">
                <input type="text" id="apiEndpoint" placeholder="API Endpoint" value="https://4ib0hvu1xj.execute-api.us-east-1.amazonaws.com/prod">
                <button onclick="saveConfig()">Save Config</button>
                <button onclick="loadConfig()" class="secondary">Load Default</button>
            </div>

            <div class="test-card">
                <h3>üîê Authentication Mode</h3>
                <select id="authMode" onchange="updateAuthMode()">
                    <option value="developer">Developer (Token)</option>
                    <option value="guest">Guest User</option>
                    <option value="none">No Auth</option>
                </select>
                <input type="text" id="customToken" placeholder="Custom token (optional)" style="margin-top: 10px;">
                <button onclick="testAuth()">Test Current Auth</button>
                <div id="authResult" class="result-box" style="display: none;"></div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('basic')">Basic Operations</button>
                <button class="tab-button" onclick="showTab('advanced')">Advanced Testing</button>
                <button class="tab-button" onclick="showTab('batch')">Batch Operations</button>
                <button class="tab-button" onclick="showTab('performance')">Performance Testing</button>
            </div>

            <!-- Basic Operations Tab -->
            <div id="basic-tab" class="tab-content active">
                <div class="test-grid">
                    <div class="test-card">
                        <h3>‚úçÔ∏è Post Comment</h3>
                        <textarea id="commentText" rows="3" placeholder="Enter your comment...">This is a test comment from the comprehensive test suite!</textarea>
                        <input type="number" id="rating" min="1" max="5" placeholder="Rating (1-5)" value="5">
                        <input type="text" id="userName" placeholder="User Name (optional)">
                        <button onclick="postComment()">Post Comment</button>
                        <button onclick="postGuestComment()" class="secondary">Post as Guest</button>
                        <div id="postResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>üìñ Get Comments</h3>
                        <input type="number" id="limit" placeholder="Limit (default: 20)" value="10">
                        <input type="text" id="lastKey" placeholder="Pagination key (optional)">
                        <button onclick="getComments()">Get Comments</button>
                        <button onclick="getCommentsWithStats()" class="secondary">Get with Stats</button>
                        <div id="getResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>‚úèÔ∏è Update Comment</h3>
                        <input type="text" id="updateCommentId" placeholder="Comment ID">
                        <textarea id="updateText" rows="3" placeholder="Updated comment text">This comment has been updated!</textarea>
                        <button onclick="updateComment()">Update Comment</button>
                        <div id="updateResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>üóëÔ∏è Delete Comment</h3>
                        <input type="text" id="deleteCommentId" placeholder="Comment ID">
                        <button onclick="deleteComment()" class="danger">Delete Comment</button>
                        <button onclick="getLatestCommentId()" class="secondary">Get Latest ID</button>
                        <div id="deleteResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>üëç Like Comment</h3>
                        <input type="text" id="likeCommentId" placeholder="Comment ID">
                        <button onclick="likeComment()">Like Comment</button>
                        <button onclick="likeMultiple()" class="secondary">Like Multiple (5x)</button>
                        <div id="likeResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>‚ö° Quick Actions</h3>
                        <button onclick="postAndGet()">Post & Get</button>
                        <button onclick="testCRUD()">Test Full CRUD</button>
                        <button onclick="testPermissions()">Test Permissions</button>
                        <button onclick="clearTestData()" class="danger">Clear Test Data</button>
                        <div id="quickResult" class="result-box" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Advanced Testing Tab -->
            <div id="advanced-tab" class="tab-content">
                <div class="test-grid">
                    <div class="test-card">
                        <h3>üîÑ Pagination Testing</h3>
                        <button onclick="testPagination()">Test Pagination Flow</button>
                        <button onclick="loadAllPages()">Load All Pages</button>
                        <div id="paginationResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>‚≠ê Rating System</h3>
                        <button onclick="testRatingAggregation()">Test Rating Aggregation</button>
                        <button onclick="postMultipleRatings()">Post Multiple Ratings</button>
                        <div id="ratingResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>üõ°Ô∏è Security Testing</h3>
                        <button onclick="testInjection()">Test SQL Injection</button>
                        <button onclick="testXSS()">Test XSS</button>
                        <button onclick="testAuthBypass()">Test Auth Bypass</button>
                        <div id="securityResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>üéØ Edge Cases</h3>
                        <button onclick="testEmptyComment()">Empty Comment</button>
                        <button onclick="testLongComment()">Very Long Comment</button>
                        <button onclick="testSpecialChars()">Special Characters</button>
                        <button onclick="testUnicode()">Unicode/Emoji</button>
                        <div id="edgeResult" class="result-box" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Batch Operations Tab -->
            <div id="batch-tab" class="tab-content">
                <div class="test-grid">
                    <div class="test-card">
                        <h3>üì¶ Batch Comments</h3>
                        <input type="number" id="batchCount" placeholder="Number of comments" value="10">
                        <button onclick="postBatchComments()">Post Batch</button>
                        <button onclick="deleteBatchComments()" class="danger">Delete Batch</button>
                        <div id="batchResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>üé≤ Random Data</h3>
                        <button onclick="generateRandomComments()">Generate Random Comments</button>
                        <button onclick="simulateRealUsage()">Simulate Real Usage</button>
                        <div id="randomResult" class="result-box" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Performance Testing Tab -->
            <div id="performance-tab" class="tab-content">
                <div class="test-grid">
                    <div class="test-card">
                        <h3>‚ö° Performance Metrics</h3>
                        <button onclick="measureLatency()">Measure Latency</button>
                        <button onclick="stressTest()">Stress Test (100 requests)</button>
                        <button onclick="testConcurrency()">Test Concurrency</button>
                        <div id="performanceResult" class="result-box" style="display: none;"></div>
                    </div>

                    <div class="test-card">
                        <h3>üìä Analytics</h3>
                        <button onclick="getPerformanceStats()">Get Performance Stats</button>
                        <button onclick="exportResults()">Export Results</button>
                        <div id="analyticsResult" class="result-box" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Display -->
        <div class="comments-display">
            <h2>üí¨ Comments List</h2>
            <div id="commentsList"></div>
        </div>

        <!-- Test Summary -->
        <div class="test-summary">
            <h2>üìä Test Summary</h2>
            <div class="test-stats">
                <div class="stat-card">
                    <div class="value" id="totalTests">0</div>
                    <div class="label">Total Tests</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="passedTests">0</div>
                    <div class="label">Passed</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="failedTests">0</div>
                    <div class="label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="avgLatency">0ms</div>
                    <div class="label">Avg Latency</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let config = {
            apiBase: 'https://4ib0hvu1xj.execute-api.us-east-1.amazonaws.com/prod',
            gameId: 'test_game_123',
            authMode: 'developer'
        };

        // Test statistics
        let stats = {
            total: 0,
            passed: 0,
            failed: 0,
            latencies: []
        };

        // Test data storage
        let testComments = [];
        let performanceData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            checkAuthStatus();
            updateAuthMode();
        });

        // Configuration functions
        function saveConfig() {
            config.apiBase = document.getElementById('apiEndpoint').value;
            config.gameId = document.getElementById('testGameId').value;
            localStorage.setItem('commentsTestConfig', JSON.stringify(config));
            showResult('info', 'Configuration saved!', document.getElementById('postResult'));
        }

        function loadConfig() {
            const saved = localStorage.getItem('commentsTestConfig');
            if (saved) {
                config = JSON.parse(saved);
            }
            document.getElementById('apiEndpoint').value = config.apiBase;
            document.getElementById('testGameId').value = config.gameId;
            document.getElementById('authMode').value = config.authMode;
        }

        // Tab navigation
        function showTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tab + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Authentication functions
        async function checkAuthStatus() {
            const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
            const authDiv = document.getElementById('authStatus');
            
            if (token) {
                authDiv.innerHTML = '<span class="status-indicator connected">üü¢ Authenticated</span>';
            } else {
                authDiv.innerHTML = '<span class="status-indicator disconnected">üî¥ Not Authenticated</span>';
            }
        }

        function updateAuthMode() {
            const mode = document.getElementById('authMode').value;
            config.authMode = mode;
        }

        function getAuthHeaders() {
            const mode = config.authMode;
            const headers = {
                'Content-Type': 'application/json'
            };

            if (mode === 'developer') {
                const token = localStorage.getItem('developerToken') || 
                            sessionStorage.getItem('developerToken') ||
                            document.getElementById('customToken').value;
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
            } else if (mode === 'guest') {
                headers['Authorization'] = `Bearer guest-test-${Date.now()}`;
            }

            return headers;
        }

        // Test functions
        async function testAuth() {
            const startTime = Date.now();
            const resultDiv = document.getElementById('authResult');
            resultDiv.style.display = 'block';
            
            try {
                const headers = getAuthHeaders();
                resultDiv.innerHTML = '<div class="loading"></div> Testing authentication...';
                
                const response = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                    headers
                });
                
                const latency = Date.now() - startTime;
                
                if (response.ok) {
                    showResult('success', `‚úÖ Auth test passed! Mode: ${config.authMode}\nLatency: ${latency}ms`, resultDiv);
                } else {
                    showResult('error', `‚ùå Auth test failed: ${response.status} ${response.statusText}`, resultDiv);
                }
            } catch (error) {
                showResult('error', `‚ùå Auth test error: ${error.message}`, resultDiv);
            }
        }

        // Basic operations
        async function postComment(asGuest = false) {
            recordTest();
            const startTime = Date.now();
            const resultDiv = document.getElementById('postResult');
            resultDiv.style.display = 'block';
            
            const comment = document.getElementById('commentText').value;
            const rating = parseInt(document.getElementById('rating').value) || null;
            const userName = document.getElementById('userName').value || null;
            
            if (!comment) {
                showResult('error', 'Please enter a comment', resultDiv);
                recordTest(false);
                return;
            }
            
            try {
                const headers = asGuest ? 
                    { 'Content-Type': 'application/json', 'Authorization': `Bearer guest-${Date.now()}` } :
                    getAuthHeaders();
                
                const response = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ comment, rating, userName })
                });
                
                const data = await response.json();
                const latency = Date.now() - startTime;
                recordLatency(latency);
                
                if (response.ok) {
                    testComments.push(data.comment);
                    showResult('success', 
                        `‚úÖ Comment posted successfully!\nID: ${data.comment?.commentId}\nLatency: ${latency}ms\n\n${JSON.stringify(data, null, 2)}`, 
                        resultDiv
                    );
                    recordTest(true);
                    // Refresh comments list
                    getComments();
                } else {
                    showResult('error', `‚ùå Error: ${data.message}`, resultDiv);
                    recordTest(false);
                }
            } catch (error) {
                showResult('error', `‚ùå Error: ${error.message}`, resultDiv);
                recordTest(false);
            }
        }

        async function postGuestComment() {
            postComment(true);
        }

        async function getComments() {
            recordTest();
            const startTime = Date.now();
            const resultDiv = document.getElementById('getResult');
            resultDiv.style.display = 'block';
            
            const limit = document.getElementById('limit').value || 20;
            const lastKey = document.getElementById('lastKey').value;
            
            try {
                let url = `${config.apiBase}/games/${config.gameId}/comments?limit=${limit}`;
                if (lastKey) url += `&lastKey=${lastKey}`;
                
                const response = await fetch(url);
                const data = await response.json();
                const latency = Date.now() - startTime;
                recordLatency(latency);
                
                if (response.ok && data.success) {
                    showResult('success', 
                        `‚úÖ Found ${data.count} comments\nLatency: ${latency}ms\n${data.nextKey ? `Next page key: ${data.nextKey}` : 'No more pages'}`, 
                        resultDiv
                    );
                    recordTest(true);
                    displayComments(data.comments);
                } else {
                    showResult('error', `‚ùå Error: ${data.message}`, resultDiv);
                    recordTest(false);
                }
            } catch (error) {
                showResult('error', `‚ùå Error: ${error.message}`, resultDiv);
                recordTest(false);
            }
        }

        async function updateComment() {
            recordTest();
            const startTime = Date.now();
            const resultDiv = document.getElementById('updateResult');
            resultDiv.style.display = 'block';
            
            const commentId = document.getElementById('updateCommentId').value;
            const comment = document.getElementById('updateText').value;
            
            if (!commentId || !comment) {
                showResult('error', 'Please enter comment ID and text', resultDiv);
                recordTest(false);
                return;
            }
            
            try {
                const response = await fetch(`${config.apiBase}/comments/${commentId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ comment })
                });
                
                const data = await response.json();
                const latency = Date.now() - startTime;
                recordLatency(latency);
                
                if (response.ok) {
                    showResult('success', `‚úÖ Comment updated!\nLatency: ${latency}ms`, resultDiv);
                    recordTest(true);
                    getComments();
                } else {
                    showResult('error', `‚ùå Error: ${data.message}`, resultDiv);
                    recordTest(false);
                }
            } catch (error) {
                showResult('error', `‚ùå Error: ${error.message}`, resultDiv);
                recordTest(false);
            }
        }

        async function deleteComment() {
            recordTest();
            const startTime = Date.now();
            const resultDiv = document.getElementById('deleteResult');
            resultDiv.style.display = 'block';
            
            const commentId = document.getElementById('deleteCommentId').value;
            
            if (!commentId) {
                showResult('error', 'Please enter comment ID', resultDiv);
                recordTest(false);
                return;
            }
            
            try {
                const response = await fetch(`${config.apiBase}/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                const latency = Date.now() - startTime;
                recordLatency(latency);
                
                if (response.ok) {
                    showResult('success', `‚úÖ Comment deleted!\nLatency: ${latency}ms`, resultDiv);
                    recordTest(true);
                    getComments();
                } else {
                    showResult('error', `‚ùå Error: ${data.message}`, resultDiv);
                    recordTest(false);
                }
            } catch (error) {
                showResult('error', `‚ùå Error: ${error.message}`, resultDiv);
                recordTest(false);
            }
        }

        async function likeComment() {
            recordTest();
            const startTime = Date.now();
            const resultDiv = document.getElementById('likeResult');
            resultDiv.style.display = 'block';
            
            const commentId = document.getElementById('likeCommentId').value;
            
            if (!commentId) {
                showResult('error', 'Please enter comment ID', resultDiv);
                recordTest(false);
                return;
            }
            
            try {
                const response = await fetch(`${config.apiBase}/comments/${commentId}/like`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                const latency = Date.now() - startTime;
                recordLatency(latency);
                
                if (response.ok) {
                    showResult('success', `‚úÖ Comment liked!\nLatency: ${latency}ms`, resultDiv);
                    recordTest(true);
                    getComments();
                } else {
                    showResult('error', `‚ùå Error: ${data.message}`, resultDiv);
                    recordTest(false);
                }
            } catch (error) {
                showResult('error', `‚ùå Error: ${error.message}`, resultDiv);
                recordTest(false);
            }
        }

        // Advanced test functions
        async function testCRUD() {
            const resultDiv = document.getElementById('quickResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üîÑ Running full CRUD test...\n\n';
            
            try {
                // 1. Create
                resultDiv.innerHTML += '1. Creating comment... ';
                const createResponse = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        comment: 'CRUD test comment',
                        rating: 4
                    })
                });
                const createData = await createResponse.json();
                
                if (!createResponse.ok) throw new Error(createData.message);
                const commentId = createData.comment.commentId;
                resultDiv.innerHTML += '‚úÖ\n';
                
                // 2. Read
                resultDiv.innerHTML += '2. Reading comment... ';
                const readResponse = await fetch(`${config.apiBase}/games/${config.gameId}/comments`);
                const readData = await readResponse.json();
                
                if (!readResponse.ok) throw new Error(readData.message);
                const found = readData.comments.find(c => c.commentId === commentId);
                if (!found) throw new Error('Comment not found');
                resultDiv.innerHTML += '‚úÖ\n';
                
                // 3. Update
                resultDiv.innerHTML += '3. Updating comment... ';
                const updateResponse = await fetch(`${config.apiBase}/comments/${commentId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ comment: 'CRUD test comment - UPDATED' })
                });
                
                if (!updateResponse.ok) {
                    const updateData = await updateResponse.json();
                    throw new Error(updateData.message);
                }
                resultDiv.innerHTML += '‚úÖ\n';
                
                // 4. Delete
                resultDiv.innerHTML += '4. Deleting comment... ';
                const deleteResponse = await fetch(`${config.apiBase}/comments/${commentId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (!deleteResponse.ok) {
                    const deleteData = await deleteResponse.json();
                    throw new Error(deleteData.message);
                }
                resultDiv.innerHTML += '‚úÖ\n';
                
                resultDiv.innerHTML += '\n‚úÖ All CRUD operations completed successfully!';
                resultDiv.className = 'result-box success';
                
            } catch (error) {
                resultDiv.innerHTML += `‚ùå\n\nError: ${error.message}`;
                resultDiv.className = 'result-box error';
            }
        }

        async function testPermissions() {
            const resultDiv = document.getElementById('quickResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üîê Testing permissions...\n\n';
            
            try {
                // Test 1: Guest can read
                resultDiv.innerHTML += '1. Guest can read comments... ';
                const guestRead = await fetch(`${config.apiBase}/games/${config.gameId}/comments`);
                if (guestRead.ok) {
                    resultDiv.innerHTML += '‚úÖ\n';
                } else {
                    resultDiv.innerHTML += '‚ùå\n';
                }
                
                // Test 2: Guest can post
                resultDiv.innerHTML += '2. Guest can post comments... ';
                const guestPost = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer guest-test123'
                    },
                    body: JSON.stringify({ comment: 'Guest comment' })
                });
                const guestPostData = await guestPost.json();
                if (guestPost.ok) {
                    resultDiv.innerHTML += '‚úÖ\n';
                } else {
                    resultDiv.innerHTML += `‚ùå (${guestPostData.message})\n`;
                }
                
                // Test 3: No auth can't post
                resultDiv.innerHTML += '3. No auth cannot post comments... ';
                const noAuthPost = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: 'No auth comment' })
                });
                if (!noAuthPost.ok) {
                    resultDiv.innerHTML += '‚úÖ (Correctly blocked)\n';
                } else {
                    resultDiv.innerHTML += '‚ùå (Should have been blocked)\n';
                }
                
                // Test 4: Can't delete others' comments
                resultDiv.innerHTML += '4. Cannot delete other users comments... ';
                // First create a comment as developer
                const devComment = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ comment: 'Developer comment' })
                });
                
                if (devComment.ok) {
                    const devData = await devComment.json();
                    // Try to delete as guest
                    const guestDelete = await fetch(`${config.apiBase}/comments/${devData.comment.commentId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': 'Bearer guest-test456' }
                    });
                    
                    if (!guestDelete.ok) {
                        resultDiv.innerHTML += '‚úÖ (Correctly blocked)\n';
                    } else {
                        resultDiv.innerHTML += '‚ùå (Should have been blocked)\n';
                    }
                    
                    // Clean up
                    await fetch(`${config.apiBase}/comments/${devData.comment.commentId}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                }
                
                resultDiv.innerHTML += '\n‚úÖ Permission tests completed!';
                resultDiv.className = 'result-box success';
                
            } catch (error) {
                resultDiv.innerHTML += `\n‚ùå Error: ${error.message}`;
                resultDiv.className = 'result-box error';
            }
        }

        // Batch operations
        async function postBatchComments() {
            const resultDiv = document.getElementById('batchResult');
            resultDiv.style.display = 'block';
            const count = parseInt(document.getElementById('batchCount').value) || 10;
            
            resultDiv.innerHTML = `üì¶ Posting ${count} comments...\n\n`;
            let successful = 0;
            let failed = 0;
            
            const startTime = Date.now();
            
            for (let i = 0; i < count; i++) {
                try {
                    const response = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            comment: `Batch comment #${i + 1} - Posted at ${new Date().toLocaleTimeString()}`,
                            rating: Math.floor(Math.random() * 5) + 1
                        })
                    });
                    
                    if (response.ok) {
                        successful++;
                        const data = await response.json();
                        testComments.push(data.comment);
                    } else {
                        failed++;
                    }
                    
                    resultDiv.innerHTML = `üì¶ Progress: ${i + 1}/${count} (‚úÖ ${successful} ‚ùå ${failed})\n`;
                } catch (error) {
                    failed++;
                }
            }
            
            const totalTime = Date.now() - startTime;
            resultDiv.innerHTML += `\n‚úÖ Batch complete!\n`;
            resultDiv.innerHTML += `Time: ${totalTime}ms (${Math.round(totalTime / count)}ms per comment)\n`;
            resultDiv.innerHTML += `Success: ${successful}/${count}`;
            resultDiv.className = 'result-box ' + (failed === 0 ? 'success' : 'error');
            
            // Refresh comments
            getComments();
        }

        // Performance testing
        async function measureLatency() {
            const resultDiv = document.getElementById('performanceResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '‚ö° Measuring API latency...\n\n';
            
            const endpoints = [
                { name: 'GET Comments', method: 'GET', url: `/games/${config.gameId}/comments` },
                { name: 'POST Comment', method: 'POST', url: `/games/${config.gameId}/comments`, 
                  body: { comment: 'Latency test' } },
            ];
            
            for (const endpoint of endpoints) {
                const latencies = [];
                
                for (let i = 0; i < 5; i++) {
                    const startTime = Date.now();
                    
                    try {
                        const options = {
                            method: endpoint.method,
                            headers: getAuthHeaders()
                        };
                        
                        if (endpoint.body) {
                            options.body = JSON.stringify(endpoint.body);
                        }
                        
                        const response = await fetch(`${config.apiBase}${endpoint.url}`, options);
                        const latency = Date.now() - startTime;
                        latencies.push(latency);
                        
                        // Clean up test comments
                        if (endpoint.method === 'POST' && response.ok) {
                            const data = await response.json();
                            await fetch(`${config.apiBase}/comments/${data.comment.commentId}`, {
                                method: 'DELETE',
                                headers: getAuthHeaders()
                            });
                        }
                    } catch (error) {
                        latencies.push(-1);
                    }
                }
                
                const avgLatency = Math.round(latencies.filter(l => l > 0).reduce((a, b) => a + b, 0) / latencies.filter(l => l > 0).length);
                const minLatency = Math.min(...latencies.filter(l => l > 0));
                const maxLatency = Math.max(...latencies.filter(l => l > 0));
                
                resultDiv.innerHTML += `${endpoint.name}:\n`;
                resultDiv.innerHTML += `  Average: ${avgLatency}ms\n`;
                resultDiv.innerHTML += `  Min: ${minLatency}ms, Max: ${maxLatency}ms\n\n`;
            }
            
            resultDiv.className = 'result-box info';
        }

        // Security testing
        async function testInjection() {
            const resultDiv = document.getElementById('securityResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üõ°Ô∏è Testing SQL injection protection...\n\n';
            
            const injectionTests = [
                "'; DROP TABLE comments; --",
                "1' OR '1'='1",
                "${1+1}",
                "<script>alert('xss')</script>",
                "{{7*7}}"
            ];
            
            for (const payload of injectionTests) {
                try {
                    const response = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ comment: payload })
                    });
                    
                    if (response.ok) {
                        resultDiv.innerHTML += `‚úÖ Payload safely handled: "${payload.substring(0, 30)}..."\n`;
                        const data = await response.json();
                        // Clean up
                        await fetch(`${config.apiBase}/comments/${data.comment.commentId}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });
                    }
                } catch (error) {
                    resultDiv.innerHTML += `‚ùå Error with payload: ${payload}\n`;
                }
            }
            
            resultDiv.className = 'result-box info';
        }

        // Helper functions
        function displayComments(comments) {
            const listDiv = document.getElementById('commentsList');
            
            if (!comments || comments.length === 0) {
                listDiv.innerHTML = '<p style="color: #6b7280;">No comments yet.</p>';
                return;
            }
            
            listDiv.innerHTML = comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-header">
                        <div>
                            <span class="comment-author">${comment.userName}</span>
                            ${comment.isGuest ? '<span style="color: #6b7280;">(Guest)</span>' : ''}
                        </div>
                        <div>${new Date(comment.createdAt).toLocaleString()}</div>
                    </div>
                    ${comment.rating ? `<div class="comment-rating">‚≠ê ${comment.rating}/5</div>` : ''}
                    <div class="comment-text">${escapeHtml(comment.comment)}</div>
                    <div class="comment-actions">
                        <span class="comment-action" onclick="setCommentId('${comment.commentId}')">
                            üìã Copy ID
                        </span>
                        <span class="comment-action" onclick="likeCommentById('${comment.commentId}')">
                            üëç Like (${comment.likes || 0})
                        </span>
                        ${comment.isEdited ? '<span style="color: #6b7280;">Edited</span>' : ''}
                    </div>
                </div>
            `).join('');
        }

        function setCommentId(commentId) {
            document.getElementById('updateCommentId').value = commentId;
            document.getElementById('deleteCommentId').value = commentId;
            document.getElementById('likeCommentId').value = commentId;
            showResult('info', `Comment ID copied: ${commentId}`, document.getElementById('quickResult'));
        }

        async function likeCommentById(commentId) {
            document.getElementById('likeCommentId').value = commentId;
            await likeComment();
        }

        function getLatestCommentId() {
            getComments().then(() => {
                const comments = document.querySelectorAll('.comment-item');
                if (comments.length > 0) {
                    const firstComment = comments[0];
                    const match = firstComment.innerHTML.match(/setCommentId\('([^']+)'\)/);
                    if (match) {
                        setCommentId(match[1]);
                    }
                }
            });
        }

        async function postAndGet() {
            await postComment();
            setTimeout(() => getComments(), 500);
        }

        async function clearTestData() {
            if (!confirm('Delete all test comments? This cannot be undone!')) return;
            
            const resultDiv = document.getElementById('quickResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üóëÔ∏è Clearing test data...\n\n';
            
            let deleted = 0;
            for (const comment of testComments) {
                try {
                    await fetch(`${config.apiBase}/comments/${comment.commentId}`, {
                        method: 'DELETE',
                        headers: getAuthHeaders()
                    });
                    deleted++;
                } catch (error) {
                    console.error('Failed to delete:', comment.commentId);
                }
            }
            
            resultDiv.innerHTML += `‚úÖ Deleted ${deleted} test comments`;
            resultDiv.className = 'result-box success';
            testComments = [];
            getComments();
        }

        function showResult(type, message, element) {
            element.innerHTML = message;
            element.className = 'result-box ' + type;
            element.style.display = 'block';
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Test tracking
        function recordTest(success = null) {
            if (success === null) {
                stats.total++;
            } else if (success) {
                stats.passed++;
            } else {
                stats.failed++;
            }
            updateStats();
        }

        function recordLatency(latency) {
            stats.latencies.push(latency);
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = stats.total;
            document.getElementById('passedTests').textContent = stats.passed;
            document.getElementById('failedTests').textContent = stats.failed;
            
            if (stats.latencies.length > 0) {
                const avg = Math.round(stats.latencies.reduce((a, b) => a + b, 0) / stats.latencies.length);
                document.getElementById('avgLatency').textContent = avg + 'ms';
            }
        }

        // Additional test functions for advanced tab
        async function testPagination() {
            const resultDiv = document.getElementById('paginationResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'üìÑ Testing pagination...\n\n';
            
            let allComments = [];
            let pageCount = 0;
            let nextKey = null;
            
            do {
                try {
                    let url = `${config.apiBase}/games/${config.gameId}/comments?limit=5`;
                    if (nextKey) url += `&lastKey=${nextKey}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        pageCount++;
                        allComments = allComments.concat(data.comments);
                        nextKey = data.nextKey;
                        
                        resultDiv.innerHTML += `Page ${pageCount}: ${data.comments.length} comments`;
                        if (nextKey) {
                            resultDiv.innerHTML += ` (has next page)\n`;
                        } else {
                            resultDiv.innerHTML += ` (last page)\n`;
                        }
                    } else {
                        break;
                    }
                } catch (error) {
                    resultDiv.innerHTML += `\n‚ùå Error: ${error.message}`;
                    break;
                }
            } while (nextKey && pageCount < 10); // Limit to 10 pages for safety
            
            resultDiv.innerHTML += `\n‚úÖ Total: ${allComments.length} comments across ${pageCount} pages`;
            resultDiv.className = 'result-box success';
        }

        async function generateRandomComments() {
            const resultDiv = document.getElementById('randomResult');
            resultDiv.style.display = 'block';
            
            const templates = [
                "Great game! Really enjoyed playing it.",
                "Could use some improvements, but overall fun.",
                "Best game I've played this month!",
                "The graphics are amazing, gameplay needs work.",
                "Addictive and challenging. Love it!",
                "Too difficult for beginners.",
                "Perfect for casual gaming.",
                "Reminds me of classic arcade games.",
                "My kids love this game!",
                "Needs more levels and content."
            ];
            
            const names = ["Alex", "Sam", "Jordan", "Casey", "Morgan", "Taylor", "Riley", "Avery", "Quinn", "Drew"];
            
            resultDiv.innerHTML = 'üé≤ Generating random comments...\n\n';
            
            for (let i = 0; i < 5; i++) {
                const template = templates[Math.floor(Math.random() * templates.length)];
                const name = names[Math.floor(Math.random() * names.length)];
                const rating = Math.floor(Math.random() * 5) + 1;
                
                try {
                    const response = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            comment: template,
                            userName: name,
                            rating: rating
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        testComments.push(data.comment);
                        resultDiv.innerHTML += `‚úÖ Posted: "${template.substring(0, 30)}..." by ${name} (${rating}‚≠ê)\n`;
                    }
                } catch (error) {
                    resultDiv.innerHTML += `‚ùå Failed: ${error.message}\n`;
                }
            }
            
            resultDiv.className = 'result-box success';
            getComments();
        }

        async function testRatingAggregation() {
            const resultDiv = document.getElementById('ratingResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '‚≠ê Testing rating aggregation...\n\n';
            
            const ratings = [5, 4, 5, 3, 4, 5, 2, 5, 4, 5];
            let totalRating = 0;
            let count = 0;
            
            for (const rating of ratings) {
                try {
                    const response = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            comment: `Rating test comment with ${rating} stars`,
                            rating: rating
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        testComments.push(data.comment);
                        totalRating += rating;
                        count++;
                    }
                } catch (error) {
                    console.error('Rating test error:', error);
                }
            }
            
            const expectedAverage = (totalRating / count).toFixed(1);
            resultDiv.innerHTML += `Posted ${count} ratings\n`;
            resultDiv.innerHTML += `Expected average: ${expectedAverage}\n`;
            resultDiv.innerHTML += `\n‚úÖ Check the game's rating in the games table to verify aggregation`;
            resultDiv.className = 'result-box info';
        }

        async function testLongComment() {
            const resultDiv = document.getElementById('edgeResult');
            resultDiv.style.display = 'block';
            
            const longComment = 'A'.repeat(5000); // 5000 character comment
            
            try {
                const response = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ comment: longComment })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    testComments.push(data.comment);
                    showResult('success', `‚úÖ Long comment (5000 chars) posted successfully!`, resultDiv);
                } else {
                    const data = await response.json();
                    showResult('error', `‚ùå Long comment rejected: ${data.message}`, resultDiv);
                }
            } catch (error) {
                showResult('error', `‚ùå Error: ${error.message}`, resultDiv);
            }
        }

        async function testUnicode() {
            const resultDiv = document.getElementById('edgeResult');
            resultDiv.style.display = 'block';
            
            const unicodeComment = 'üéÆ √âmojis and sp√©√ßi√•l √ßh√•racters: ‰Ω†Â•Ω‰∏ñÁïå! üåç √± √º √∂ √§ üíØ';
            
            try {
                const response = await fetch(`${config.apiBase}/games/${config.gameId}/comments`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ 
                        comment: unicodeComment,
                        userName: 'ü¶Ñ √ú√±√≠√ß√∂d√© √ú≈°√©r üåà'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    testComments.push(data.comment);
                    showResult('success', `‚úÖ Unicode comment posted successfully!`, resultDiv);
                    getComments();
                } else {
                    const data = await response.json();
                    showResult('error', `‚ùå Unicode comment rejected: ${data.message}`, resultDiv);
                }
            } catch (error) {
                showResult('error', `‚ùå Error: ${error.message}`, resultDiv);
            }
        }

        // Export results
        function exportResults() {
            const results = {
                config: config,
                stats: stats,
                testComments: testComments,
                performanceData: performanceData,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comments-test-results-${Date.now()}.json`;
            a.click();
            
            showResult('success', '‚úÖ Results exported!', document.getElementById('analyticsResult'));
        }
    </script>
</body>
</html>