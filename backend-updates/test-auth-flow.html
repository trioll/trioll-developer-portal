<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentication Flow with Cognito Attributes</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }
        h1, h2 {
            color: #6366f1;
        }
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #5558e3;
        }
        button:disabled {
            background: #4a4a4a;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-left: 4px solid #10b981;
        }
        .error {
            border-left: 4px solid #ef4444;
        }
        .info {
            border-left: 4px solid #6366f1;
        }
        .warning {
            border-left: 4px solid #f59e0b;
        }
        input {
            background: #1a1a1a;
            border: 1px solid #4a4a4a;
            color: white;
            padding: 8px;
            border-radius: 4px;
            width: 300px;
            margin: 5px 0;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .token-display {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-size: 11px;
        }
        .attribute-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        .attribute-table th, .attribute-table td {
            border: 1px solid #4a4a4a;
            padding: 8px;
            text-align: left;
        }
        .attribute-table th {
            background: #3a3a3a;
        }
    </style>
</head>
<body>
    <h1>üß™ Cognito Attributes Authentication Test Suite</h1>
    
    <div class="test-section">
        <h2>üìã Test Configuration</h2>
        <div class="status-grid">
            <div>
                <h3>Endpoints</h3>
                <p>API: https://4ib0hvu1xj.execute-api.us-east-1.amazonaws.com/prod</p>
                <p>Client ID: 5joogquqr4jgukp7mncgp3g23h</p>
            </div>
            <div>
                <h3>Attribute Mapping</h3>
                <table class="attribute-table">
                    <tr>
                        <th>Cognito Attribute</th>
                        <th>Maps To</th>
                    </tr>
                    <tr>
                        <td>preferred_username</td>
                        <td>developer_id</td>
                    </tr>
                    <tr>
                        <td>website</td>
                        <td>company_name</td>
                    </tr>
                    <tr>
                        <td>profile</td>
                        <td>user_type</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üîê Test 1: Login & Token Verification</h2>
        <p>Login with freddiecaplin@hotmail.com and verify token contains developer attributes</p>
        
        <input type="email" id="loginEmail" value="freddiecaplin@hotmail.com" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <br>
        <button onclick="testLogin()">Test Login</button>
        <button onclick="decodeCurrentToken()">Decode Current Token</button>
        <button onclick="clearTokens()">Clear All Tokens</button>
        
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>üë§ Test 2: Profile API</h2>
        <p>Fetch developer profile using token with Cognito attributes</p>
        
        <button onclick="testProfile()" id="profileBtn">Test Profile Endpoint</button>
        
        <div id="profileResult"></div>
    </div>

    <div class="test-section">
        <h2>üéÆ Test 3: Games API Integration</h2>
        <p>Test if games API correctly reads developer_id from token</p>
        
        <button onclick="testDeveloperGames()" id="gamesBtn">Test /developers/games</button>
        <button onclick="testCreateGame()" id="createBtn">Test POST /games</button>
        
        <div id="gamesResult"></div>
    </div>

    <div class="test-section">
        <h2>üìä Test 4: Full Authentication Flow</h2>
        <button onclick="runFullTest()">Run Complete Test Suite</button>
        
        <div id="fullTestResult"></div>
    </div>

    <script>
        const API_URL = 'https://4ib0hvu1xj.execute-api.us-east-1.amazonaws.com/prod';
        let currentToken = null;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = typeof message === 'string' ? message : JSON.stringify(message, null, 2);
            element.innerHTML = '';
            element.appendChild(div);
        }

        function addResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = typeof message === 'string' ? message : JSON.stringify(message, null, 2);
            element.appendChild(div);
        }

        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!password) {
                showResult('loginResult', 'Please enter password', 'error');
                return;
            }
            
            showResult('loginResult', 'üîÑ Testing login...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/developers/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-App-Client': 'developer-portal'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.tokens) {
                    currentToken = data.tokens.idToken;
                    sessionStorage.setItem('developerToken', currentToken);
                    
                    // Decode and display token
                    const decoded = decodeJWT(currentToken);
                    
                    addResult('loginResult', `‚úÖ Login successful!`, 'success');
                    addResult('loginResult', `Developer: ${data.developer?.developerId || 'Not provided'}`, 'info');
                    
                    // Display token info
                    const tokenDiv = document.createElement('div');
                    tokenDiv.className = 'token-display';
                    tokenDiv.innerHTML = `<strong>Token Payload:</strong>\n${JSON.stringify(decoded, null, 2)}`;
                    document.getElementById('loginResult').appendChild(tokenDiv);
                    
                    // Check for developer attributes
                    addResult('loginResult', '\nüîç Checking for developer attributes in token:', 'info');
                    addResult('loginResult', `preferred_username (developer_id): ${decoded.preferred_username || '‚ùå NOT FOUND'}`, 
                        decoded.preferred_username ? 'success' : 'error');
                    addResult('loginResult', `website (company_name): ${decoded.website || '‚ùå NOT FOUND'}`, 
                        decoded.website ? 'success' : 'error');
                    addResult('loginResult', `profile (user_type): ${decoded.profile || '‚ùå NOT FOUND'}`, 
                        decoded.profile ? 'success' : 'error');
                    
                    // Enable other tests
                    document.getElementById('profileBtn').disabled = false;
                    document.getElementById('gamesBtn').disabled = false;
                    document.getElementById('createBtn').disabled = false;
                    
                } else {
                    showResult('loginResult', `‚ùå Login failed: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResult('loginResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        function decodeJWT(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) throw new Error('Invalid JWT');
                return JSON.parse(atob(parts[1]));
            } catch (error) {
                return { error: 'Failed to decode token' };
            }
        }

        function decodeCurrentToken() {
            const token = currentToken || sessionStorage.getItem('developerToken');
            if (!token) {
                showResult('loginResult', '‚ùå No token found. Please login first.', 'error');
                return;
            }
            
            const decoded = decodeJWT(token);
            showResult('loginResult', `Current Token Payload:\n${JSON.stringify(decoded, null, 2)}`, 'info');
        }

        function clearTokens() {
            currentToken = null;
            sessionStorage.clear();
            localStorage.clear();
            showResult('loginResult', '‚úÖ All tokens cleared', 'success');
            
            // Disable buttons
            document.getElementById('profileBtn').disabled = true;
            document.getElementById('gamesBtn').disabled = true;
            document.getElementById('createBtn').disabled = true;
        }

        async function testProfile() {
            const token = currentToken || sessionStorage.getItem('developerToken');
            if (!token) {
                showResult('profileResult', '‚ùå No token found. Please login first.', 'error');
                return;
            }
            
            showResult('profileResult', 'üîÑ Testing profile endpoint...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/developers/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-App-Client': 'developer-portal'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('profileResult', `‚úÖ Profile fetched successfully!\n\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult('profileResult', `‚ùå Profile fetch failed: ${response.status}\n\n${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('profileResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function testDeveloperGames() {
            const token = currentToken || sessionStorage.getItem('developerToken');
            if (!token) {
                showResult('gamesResult', '‚ùå No token found. Please login first.', 'error');
                return;
            }
            
            showResult('gamesResult', 'üîÑ Testing /developers/games endpoint...', 'info');
            
            try {
                const response = await fetch(`${API_URL}/developers/games`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'X-App-Client': 'developer-portal'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addResult('gamesResult', `‚úÖ Developer games fetched successfully!`, 'success');
                    addResult('gamesResult', `Found ${data.games?.length || 0} games`, 'info');
                    if (data.games?.length > 0) {
                        addResult('gamesResult', `First game: ${data.games[0].title}`, 'info');
                    }
                } else {
                    addResult('gamesResult', `‚ùå Games fetch failed: ${response.status}`, 'error');
                    addResult('gamesResult', JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                showResult('gamesResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function testCreateGame() {
            const token = currentToken || sessionStorage.getItem('developerToken');
            if (!token) {
                showResult('gamesResult', '‚ùå No token found. Please login first.', 'error');
                return;
            }
            
            addResult('gamesResult', '\nüîÑ Testing POST /games endpoint...', 'info');
            
            const testGame = {
                gameId: `test-cognito-${Date.now()}`,
                name: 'Cognito Attributes Test Game',
                description: 'Testing game creation with Cognito attributes',
                category: 'Action',
                developer: 'FreddieTrioll',
                developerId: 'dev_c84a7e',
                deviceOrientation: 'Both',
                controlStyle: 'Tap & Swipe Only',
                gameStage: 'Released (In App Store)',
                deviceCompatibility: ['Mobile iOS', 'Mobile Android'],
                gameUrl: 'https://example.com/game',
                thumbnailUrl: 'https://example.com/thumbnail.png'
            };
            
            try {
                const response = await fetch(`${API_URL}/games`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-App-Client': 'developer-portal'
                    },
                    body: JSON.stringify(testGame)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addResult('gamesResult', `‚úÖ Game created successfully!`, 'success');
                    addResult('gamesResult', `Game ID: ${data.gameId}`, 'info');
                    addResult('gamesResult', `Developer: ${data.developer?.name} (${data.developer?.id})`, 'info');
                } else {
                    addResult('gamesResult', `‚ùå Game creation failed: ${response.status}`, 'error');
                    addResult('gamesResult', JSON.stringify(data, null, 2), 'error');
                }
            } catch (error) {
                addResult('gamesResult', `‚ùå Network error: ${error.message}`, 'error');
            }
        }

        async function runFullTest() {
            showResult('fullTestResult', 'üöÄ Running complete test suite...', 'info');
            
            // Check if we have a token
            const token = sessionStorage.getItem('developerToken');
            if (!token) {
                addResult('fullTestResult', '‚ùå No token found. Please login first.', 'error');
                return;
            }
            
            // Decode token
            const decoded = decodeJWT(token);
            
            // Test 1: Token Structure
            addResult('fullTestResult', '\nüìã TEST 1: Token Structure', 'info');
            const hasDevId = !!decoded.preferred_username;
            const hasCompany = !!decoded.website;
            const hasUserType = !!decoded.profile;
            
            addResult('fullTestResult', `Developer ID in token: ${hasDevId ? '‚úÖ' : '‚ùå'}`, hasDevId ? 'success' : 'error');
            addResult('fullTestResult', `Company name in token: ${hasCompany ? '‚úÖ' : '‚ùå'}`, hasCompany ? 'success' : 'error');
            addResult('fullTestResult', `User type in token: ${hasUserType ? '‚úÖ' : '‚ùå'}`, hasUserType ? 'success' : 'error');
            
            // Test 2: API Authentication
            addResult('fullTestResult', '\nüìã TEST 2: API Authentication', 'info');
            
            try {
                // Test profile endpoint
                const profileRes = await fetch(`${API_URL}/developers/profile`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'X-App-Client': 'developer-portal'
                    }
                });
                addResult('fullTestResult', `/developers/profile: ${profileRes.ok ? '‚úÖ' : '‚ùå'} (${profileRes.status})`, 
                    profileRes.ok ? 'success' : 'error');
                
                // Test games endpoint
                const gamesRes = await fetch(`${API_URL}/developers/games`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'X-App-Client': 'developer-portal'
                    }
                });
                addResult('fullTestResult', `/developers/games: ${gamesRes.ok ? '‚úÖ' : '‚ùå'} (${gamesRes.status})`, 
                    gamesRes.ok ? 'success' : 'error');
                
            } catch (error) {
                addResult('fullTestResult', `API test error: ${error.message}`, 'error');
            }
            
            // Summary
            const allPassed = hasDevId && hasCompany && hasUserType;
            addResult('fullTestResult', `\nüèÅ OVERALL RESULT: ${allPassed ? 'PASSED ‚úÖ' : 'FAILED ‚ùå'}`, 
                allPassed ? 'success' : 'error');
        }

        // Check for existing token on load
        window.onload = function() {
            const token = sessionStorage.getItem('developerToken');
            if (token) {
                currentToken = token;
                document.getElementById('profileBtn').disabled = false;
                document.getElementById('gamesBtn').disabled = false;
                document.getElementById('createBtn').disabled = false;
                showResult('loginResult', '‚úÖ Found existing token in session', 'success');
            }
        };
    </script>
</body>
</html>