<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Game Edit Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #0f0f0f;
            color: #fff;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }
        button:hover {
            background: #2563eb;
        }
        .log {
            background: #1a1a1a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #2a2a2a;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <h1>Direct Game Edit Test</h1>
    <p>This page will test editing one of your games directly.</p>
    
    <button onclick="testDirectEdit()">Test Edit on "Horror Pong" Game</button>
    
    <div id="log" class="log"></div>

    <script>
        const API = 'https://4ib0hvu1xj.execute-api.us-east-1.amazonaws.com/prod';
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const span = document.createElement('div');
            span.className = type;
            span.textContent = `[${time}] ${message}`;
            logEl.appendChild(span);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function testDirectEdit() {
            log('Starting direct edit test...', 'info');
            
            // Step 1: Get token from current session
            const token = sessionStorage.getItem('developerToken') || 
                         localStorage.getItem('developerToken') ||
                         (window.opener && window.opener.sessionStorage.getItem('developerToken'));
            
            if (!token) {
                log('No token found. Please login first in the main portal.', 'error');
                return;
            }
            
            log('Token found, decoding...', 'info');
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                log(`Logged in as: ${payload.email}`, 'info');
                log(`Token expires: ${new Date(payload.exp * 1000).toLocaleString()}`, 'info');
            } catch (e) {
                log('Could not decode token', 'error');
            }
            
            // Step 2: Get all games to find Horror Pong
            log('\nFetching games list...', 'info');
            try {
                const gamesResponse = await fetch(`${API}/games`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!gamesResponse.ok) {
                    throw new Error(`Games fetch failed: ${gamesResponse.status}`);
                }
                
                const gamesData = await gamesResponse.json();
                log(`Found ${gamesData.games.length} total games`, 'info');
                
                // Find Horror Pong or first game by this developer
                const devIdFromToken = JSON.parse(atob(token.split('.')[1]))['custom:developer_id'] || 'dev_c84a7e';
                const myGames = gamesData.games.filter(g => g.developerId === devIdFromToken);
                
                log(`Found ${myGames.length} games uploaded by you`, 'info');
                
                if (myGames.length === 0) {
                    log('No games found for your developer ID', 'error');
                    return;
                }
                
                // Try to find Horror Pong specifically, or use first game
                let targetGame = myGames.find(g => g.name && g.name.toLowerCase().includes('horror')) || myGames[0];
                
                log(`\nSelected game: ${targetGame.name}`, 'success');
                log(`Game ID: ${targetGame.id || targetGame.gameId}`, 'info');
                log(`Current description: ${targetGame.description || 'None'}`, 'info');
                
                // Step 3: Update the game
                const gameId = targetGame.id || targetGame.gameId;
                const updateData = {
                    name: targetGame.name + ' (Updated)',
                    description: 'Updated via API test at ' + new Date().toLocaleString(),
                    category: targetGame.category || 'Horror',
                    status: 'active'
                };
                
                log(`\nSending PUT request to /games/${gameId}...`, 'info');
                log('Update payload:', 'info');
                log(JSON.stringify(updateData, null, 2), 'info');
                
                const updateResponse = await fetch(`${API}/games/${gameId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        'X-App-Client': 'developer-portal'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const responseText = await updateResponse.text();
                
                log(`\nResponse status: ${updateResponse.status}`, updateResponse.ok ? 'success' : 'error');
                log('Response body:', 'info');
                log(responseText, 'info');
                
                if (updateResponse.ok) {
                    log('\n✅ Update successful!', 'success');
                    
                    // Verify the update
                    log('\nVerifying update by fetching game again...', 'info');
                    const verifyResponse = await fetch(`${API}/games/${gameId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (verifyResponse.ok) {
                        const updatedGame = await verifyResponse.json();
                        log('Updated game data:', 'success');
                        log(JSON.stringify(updatedGame, null, 2), 'info');
                    }
                } else {
                    log('\n❌ Update failed', 'error');
                    
                    // Additional debugging
                    log('\nDebug info:', 'info');
                    log(`API endpoint: ${API}/games/${gameId}`, 'info');
                    log(`Token present: ${!!token}`, 'info');
                    log(`Token length: ${token.length}`, 'info');
                    
                    // Try to parse error
                    try {
                        const errorData = JSON.parse(responseText);
                        log(`Error message: ${errorData.message || 'Unknown error'}`, 'error');
                    } catch (e) {
                        log('Could not parse error response', 'error');
                    }
                }
                
            } catch (error) {
                log(`\nError: ${error.message}`, 'error');
                log(error.stack, 'error');
            }
        }
        
        // Auto-run if we have a token
        window.addEventListener('DOMContentLoaded', () => {
            const hasToken = sessionStorage.getItem('developerToken') || 
                           localStorage.getItem('developerToken') ||
                           (window.opener && window.opener.sessionStorage.getItem('developerToken'));
            
            if (hasToken) {
                log('Token detected. Click the button above to test game editing.', 'info');
            } else {
                log('No token found. Please login in the main portal first.', 'error');
            }
        });
    </script>
</body>
</html>