<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Developer ID Fixes</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 12px;
        }
        h1 { color: #10b981; }
        h2 { color: #3b82f6; margin-top: 30px; }
        .fix-item {
            background: #1f2937;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #374151;
        }
        .code-block {
            background: #000;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: monospace;
            font-size: 13px;
            position: relative;
        }
        .old-code {
            background: #7f1d1d;
            color: #fca5a5;
        }
        .new-code {
            background: #064e3b;
            color: #6ee7b7;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            font-size: 12px;
        }
        .warning {
            background: #7c2d12;
            color: #fed7aa;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Apply Developer ID Fixes to index.html</h1>
        <p>These are the specific changes needed in your index.html file to fix the developer ID issue permanently.</p>
        
        <div class="warning">
            ‚ö†Ô∏è <strong>Important:</strong> Make a backup of your index.html before applying these changes!
        </div>

        <h2>Step 1: Add Utility Functions</h2>
        <div class="fix-item">
            <p>Add these functions near the top of your script section (around line 2000):</p>
            <div class="code-block new-code">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre>// Developer ID utility functions
function getDeveloperIdFromToken() {
    const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
    if (!token) return null;
    
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        return payload['custom:developer_id'] || payload.preferred_username || null;
    } catch (e) {
        console.error('Error extracting developer ID from token:', e);
        return null;
    }
}

function getDeveloperId() {
    return getDeveloperIdFromToken();
}

function syncDeveloperIdFromToken() {
    const developerId = getDeveloperIdFromToken();
    if (developerId) {
        localStorage.setItem('developerId', developerId);
        sessionStorage.setItem('developerId', developerId);
        console.log('‚úÖ Developer ID synced:', developerId);
        return true;
    }
    return false;
}</pre>
            </div>
        </div>

        <h2>Step 2: Fix Login Success Handler</h2>
        <div class="fix-item">
            <p><strong>Line ~5410-5412:</strong> In the login success handler</p>
            <div class="code-block old-code">
                <pre>// OLD CODE - Remove this:
if (developer && developer.developerId) {
    localStorage.setItem('developerInfo', JSON.stringify(developer));
    localStorage.setItem('developerId', developer.developerId);
}</pre>
            </div>
            <div class="code-block new-code">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre>// NEW CODE - Replace with:
// Sync developer ID from JWT token
syncDeveloperIdFromToken();

// Store other developer info if provided
if (developer) {
    const devInfo = {
        ...developer,
        developerId: getDeveloperId() // Always use token value
    };
    localStorage.setItem('developerInfo', JSON.stringify(devInfo));
}</pre>
            </div>
        </div>

        <h2>Step 3: Fix loadMyGames Function</h2>
        <div class="fix-item">
            <p><strong>Line ~3255-3258:</strong> In the loadMyGames function</p>
            <div class="code-block old-code">
                <pre>// OLD CODE - Remove this:
const developerId = document.getElementById('developerId')?.value || 
                   localStorage.getItem('developerId') || 
                   sessionStorage.getItem('developerId');</pre>
            </div>
            <div class="code-block new-code">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre>// NEW CODE - Replace with:
const developerId = getDeveloperId();

if (!developerId) {
    console.error('No developer ID found in token');
    myGamesGrid.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; color: var(--text-gray-400);">
            <p>Unable to load games. Please log in again.</p>
        </div>
    `;
    return;
}</pre>
            </div>
        </div>

        <h2>Step 4: Fix Developer Profile Display</h2>
        <div class="fix-item">
            <p><strong>Around line ~2166:</strong> Where developer ID is stored after auth</p>
            <div class="code-block old-code">
                <pre>// OLD CODE - Remove this:
if (this.developerInfo && this.developerInfo.developerId) {
    localStorage.setItem('developerId', this.developerInfo.developerId);
}</pre>
            </div>
            <div class="code-block new-code">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre>// NEW CODE - Replace with:
// Always sync from token
syncDeveloperIdFromToken();</pre>
            </div>
        </div>

        <h2>Step 5: Fix All Other References</h2>
        <div class="fix-item">
            <p>Search and replace throughout the file:</p>
            <ul style="margin: 20px 0;">
                <li><code>localStorage.getItem('developerId')</code> ‚Üí <code>getDeveloperId()</code></li>
                <li><code>sessionStorage.getItem('developerId')</code> ‚Üí <code>getDeveloperId()</code></li>
                <li><code>localStorage.setItem('developerId', developer.developerId)</code> ‚Üí <code>syncDeveloperIdFromToken()</code></li>
            </ul>
        </div>

        <h2>Step 6: Add Page Load Validation</h2>
        <div class="fix-item">
            <p>Add this to your DOMContentLoaded or window.onload handler:</p>
            <div class="code-block new-code">
                <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                <pre>// On page load, sync developer ID if we have a token
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('developerToken') || sessionStorage.getItem('developerToken');
    if (token) {
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const exp = payload.exp * 1000;
            if (exp > Date.now()) {
                syncDeveloperIdFromToken();
            }
        } catch (e) {
            console.error('Token validation error:', e);
        }
    }
});</pre>
            </div>
        </div>

        <h2>Step 7: Test the Changes</h2>
        <div class="fix-item">
            <ol>
                <li>Clear your browser cache and localStorage</li>
                <li>Log in to the developer portal</li>
                <li>Check that "My Games" shows your games</li>
                <li>Test uploading a new game</li>
                <li>Test editing an existing game</li>
            </ol>
        </div>

        <div class="warning">
            üí° <strong>Quick Test:</strong> After making these changes, open the browser console and run:<br>
            <code>console.log('Token Dev ID:', getDeveloperId());</code><br>
            It should show "dev_c84a7e" not "FreddieTrioll"
        </div>
    </div>

    <script>
        function copyCode(button) {
            const codeBlock = button.parentElement.querySelector('pre');
            const text = codeBlock.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.style.background = '#10b981';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            });
        }
    </script>
</body>
</html>